<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Klubben poll_helper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #d8d4c8;
            --card-bg: #ece8dc;
            --primary-color: #3a5d9f;
            --primary-hover-color: #4a72c4;
            --secondary-color: #c88e37;
            --secondary-hover-color: #d49f4e;
            --success-color: #5a8a5a;
            --success-hover-color: #6cac6c;
            --danger-color: #a94a4a;
            --danger-hover-color: #c85a5a;
            --text-color: #333330;
            --subtle-text-color: #6b6a64;
            --border-color: #a09c91;
            --border-highlight: #f8f6f1;
            --border-shadow: #8a867d;
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--primary-color);
            --input-bg: #f9f7f2;
            --card-shadow: 2px 2px 0px 0px var(--border-shadow);
            --card-shadow-hover: 4px 4px 0px 0px var(--border-shadow);
            --font-retro: 'VT323', monospace;
            --font-sans: 'Inter', sans-serif;
            --radius: 0px;
            --winner-bg: #e5f0e5;
            --winner-border-highlight: #b8d8b8;
            --winner-border-shadow: #4a7a4a;
        }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--font-retro); line-height: 1.6; font-size: 17px;
            margin: 0; background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; align-items: center;
            padding: 20px 15px; min-height: 100vh;
        }
        .container {
            max-width: 800px; width: 100%; background: var(--card-bg);
            padding: 20px 30px; border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow); margin: 15px 0;
            border-style: outset; border-width: 2px;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
        }
        h1 {
            text-align: center; margin-bottom: 25px; font-weight: normal;
            text-transform: uppercase; letter-spacing: 1px; color: var(--primary-color);
            text-shadow: 1px 1px 0px var(--border-highlight); font-size: 2.4em;
        }
        h2 {
            font-size: 1.0em; margin: 0 0 35px 0; color: var(--subtle-text-color);
            text-transform: uppercase; font-weight: normal; text-align: center;
            border: none; padding-bottom: 0; display: block;
        }
        section { margin-bottom: 30px; padding-bottom: 5px; }
        .section-content { margin-top: -1.5em; }

        input[type="text"], input[type="url"], textarea {
            padding: 8px 10px; border: 1px solid;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
            border-style: inset; border-width: 2px; font-size: 1em;
            box-sizing: border-box; transition: border-color .2s ease, box-shadow .2s ease;
            background-color: var(--input-bg); margin-bottom: 8px; width: 100%;
            font-family: var(--font-retro); color: var(--text-color); outline: none;
        }
        input[type="text"]:focus, input[type="url"]:focus, textarea:focus { background-color: #fff; }
        textarea { resize: vertical; min-height: 60px; }
        #pollBooksTextarea {
            width: 100%; min-height: 100px; margin-top: 10px; font-size: 0.95em;
        }

        label {
            font-weight: normal; margin-right: 5px; margin-top: 20px; font-size: 1em;
            color: var(--subtle-text-color); display: inline-block; margin-bottom: 3px;
            text-transform: uppercase;
        }

        .search-input-wrapper { margin-bottom: 15px; text-align: center; }
        #searchInput {
            max-width: 550px; text-align: center; font-size: 1.1em;
            padding: 10px 12px; display: block; margin: 5px auto 0 auto;
        }

        .manual-add-area {
            margin-top: 15px; padding: 8px 10px; border-top: 1px dashed var(--border-color);
            text-align: center;
        }
        #manualEntryForm {
            display: flex; flex-wrap: wrap; align-items: flex-end; gap: 8px;
            justify-content: center;
        }
        .manual-field-group {
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .manual-field-group label {
            font-size: 0.9em; margin-bottom: 1px; color: var(--text-color);
        }
        #manualTitleInput { width: 180px; margin-bottom: 0; }
        #manualAuthorInput { width: 160px; margin-bottom: 0; }
        #manualLinkInput { width: 180px; margin-bottom: 0; }
        #addManualEntryBtn {
            margin-bottom: 0; align-self: flex-end; height: 38px; padding-top: 5px;
            margin-left: 5px;
        }

        button {
            padding: 6px 15px; font-size: 1em; font-weight: normal; color: var(--text-color);
            background-color: var(--card-bg); border: 1px solid;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; cursor: pointer;
            transition: background-color .1s ease, transform .1s ease, border-style .1s ease;
            text-align: center; line-height: 1.3; box-shadow: none;
            text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; outline: none;
        }
        button:hover { background-color: #fff; }
        button:active { border-style: inset; background-color: #f5f2ea; transform: translate(1px, 1px); }
        button:disabled {
            border-color: var(--border-color); border-style: solid; border-width: 1px;
            cursor: not-allowed; color: var(--subtle-text-color); background-color: #e5e1d8; transform: none;
        }
        #addManualEntryBtn, .btn-vote, #startPollBtn, #revealVotesBtn {
            background-color: #d4e2d4;
        }
        #addManualEntryBtn:hover, .btn-vote:hover, #startPollBtn:hover, #revealVotesBtn:hover {
            background-color: #e0f0e0;
        }
        #addManualEntryBtn:active, .btn-vote:active, #startPollBtn:active, #revealVotesBtn:active {
            background-color: #c8d8c8;
        }

        .btn-remove { background-color: #eacccc; }
        .btn-remove:hover { background-color: #f5dddd; }
        .btn-remove:active { background-color: #e0c0c0; }

        #closeSearchBtn {
            position: absolute; top: -10px; right: -1px; z-index: 10;
            padding: 1px 7px; font-size: 1.3em; line-height: 1.1; display: none;
        }

        .search-results-container { position: relative; max-width: 580px; margin: 10px auto 15px auto; }
        #searchResults {
            max-height: 220px; overflow-y: auto; padding: 5px; border: 1px solid var(--border-color);
            background: var(--input-bg); min-height: 0; border-style: inset; border-width: 2px;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
        }
        #searchResults:empty { border: none; padding: 0; }
        #searchResults:not(:empty) + #closeSearchBtn { display: block; }
        .book-item {
            display: flex; align-items: center; border-bottom: 1px dotted var(--border-color);
            padding: 6px 8px; margin-bottom: 0; background-color: transparent; transition: background-color .2s ease;
        }
        .book-item:last-child { border-bottom: none; }
        .book-item:hover { background-color: rgba(0,0,0,0.03); }
        .book-item.selected { background-color: rgba(58, 93, 159, 0.1); font-weight: bold; }
        .book-item img, .book-item .placeholder-svg {
            width: 30px; height: 45px; object-fit: cover; margin-right: 10px;
            border: 1px solid var(--border-color); flex-shrink: 0;
            image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
        }
        .book-info { flex-grow: 1; overflow: hidden; }
        .book-info p { margin: 1px 0 0 0; font-size: 0.9em; color: var(--subtle-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-info strong { font-size: 0.95em; color: var(--text-color); font-weight: normal; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 1px; }
        .book-item button { margin-left: 8px; padding: 4px 10px; font-size: 0.9em; }

        #selectedBooksList { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 15px; }
        .selected-card {
            background-color: var(--card-bg); border: 1px solid;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; box-shadow: none; text-align: center;
            display: flex; flex-direction: column;
            overflow: hidden; padding: 15px;
            transition: transform 0.1s ease-out, border-color 0.1s ease-out;
        }
        .selected-card:hover { transform: translate(-1px, -1px); border-color: #fff #aaa #aaa #fff; }
        .selected-card img, .selected-card .placeholder-svg {
            width: 85px; height: 128px; object-fit: cover; border: 1px solid;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
            border-style: inset; border-width: 2px; margin: 0 auto 10px auto;
            image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
            background-color: var(--border-color); flex-shrink: 0;
        }
        .selected-card .manual-placeholder-svg {
            border: 1px solid var(--border-color); border-style: solid; background-color: #e0dccf;
        }
        .selected-card h3 { font-size: 1.1em; margin: 4px 0 3px 0; font-weight: normal; line-height: 1.3; color: var(--text-color); text-transform: none; text-align: center; }
        .selected-card p { font-size: 1em; color: var(--subtle-text-color); margin: 2px 0; text-align: center; }
        .selected-card p em { font-style: normal; }
        .selected-card .links {
            margin-top: 8px; font-size: 0.9em; line-height: 1.4; margin-bottom: 10px;
            flex-grow: 1; min-height: calc(0.9em * 1.4); word-wrap: break-word; text-align: center;
        }
        .selected-card .links a { color: var(--primary-color); text-decoration: underline; margin: 0 5px; }
        .selected-card .links a:hover { color: var(--primary-hover-color); }
        .selected-card .card-actions {
            margin-top: auto; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; padding-top: 10px; flex-shrink: 0;
        }
        .selected-card .card-actions button {
            font-size: 0.9em; padding: 5px 12px; width: auto; height: 30px; padding-top: 4px; margin: 0;
        }

        .btn-edit { background-color: #d4ccee; }
        .btn-edit:hover { background-color: #e5ddff; }
        .btn-edit:active { background-color: #c8bfe0; }

        .selected-card.manual-entry { border-style: outset; }
        .selected-card.manual-entry .freeform-text { display: none; }

        #pollView { margin-top: 25px; text-align: center; }
        #pollTitle { font-size: 1.8em; margin-bottom: 25px; }
        .poll-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; margin-top: 20px; text-align: left; }
        .poll-option-card {
            background-color: var(--card-bg); border: 1px solid;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; box-shadow: none; padding: 18px;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.1s ease-out, border-color 0.1s ease-out, background-color 0.2s ease-out;
            position: relative;
        }
        .poll-option-card:hover { transform: translate(-1px, -1px); border-color: #fff #aaa #aaa #fff; }
        .poll-card-content { text-align: center; margin-bottom: 12px; flex-grow: 1; }
        .poll-card-content img, .poll-card-content .placeholder-svg, .poll-card-content .manual-placeholder-svg {
            margin: 0 auto 10px auto; border: 1px solid;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
            border-style: inset; border-width: 2px; width: 85px; height: 128px; object-fit: cover;
            image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
            background-color: var(--border-color);
        }
        .poll-card-content .manual-placeholder-svg {
            border: 1px solid var(--border-color); border-style: solid; background-color: #e0dccf;
        }
        .poll-option-card h4 { margin: 4px 0 4px 0; font-size: 1.15em; font-weight: normal; text-align: center; color: var(--text-color); text-transform: none; }
        .poll-option-card p { margin: 2px 0; font-size: 1em; color: var(--subtle-text-color); text-align: center; }
        .poll-option-card p em { font-style: normal; }
        .poll-option-card .links {
            margin: 10px 0; font-size: 0.9em; text-align: center;
            word-wrap: break-word; min-height: calc(0.9em * 1.4);
        }
        .poll-option-card .links a { color: var(--primary-color); text-decoration: underline; margin: 0 5px; }
        .poll-option-card .links a:hover { color: var(--primary-hover-color); }

        .vote-area { margin-top: 12px; text-align: center; border-top: 1px dashed var(--border-color); padding-top: 12px; }
        .vote-count {
            display: block; font-size: 1.15em; color: var(--primary-color); margin-bottom: 10px;
            visibility: hidden; opacity: 0; height: 0;
            transition: opacity 0.3s ease-in-out, height 0.3s ease-in-out, visibility 0.3s;
        }
        #pollView.votes-revealed .vote-count {
            visibility: visible; opacity: 1; height: auto; margin-bottom: 10px;
        }
        .btn-vote { width: auto; font-size: 1em; padding: 7px 18px; height: 34px; padding-top: 6px; }

        #revealVotesArea { margin: 25px 0 10px 0; text-align: center; }
        #revealVotesBtn { font-size: 1.05em; padding: 8px 20px; height: 36px; padding-top: 7px; }

        .poll-option-card.winner {
            border-color: var(--winner-border-highlight) var(--winner-border-shadow) var(--winner-border-shadow) var(--winner-border-highlight);
            background-color: var(--winner-bg);
        }
        .poll-option-card.winner .vote-count {
            color: var(--success-color); font-weight: bold;
        }
        .poll-option-card.winner::after {
            content: "WINNER"; display: block; position: absolute; top: 10px; right: 10px;
            background-color: var(--success-color); color: white; padding: 3px 8px;
            font-size: 0.85em; line-height: 1; border: 1px solid var(--success-hover-color);
        }

        .status-message { 
            text-align: center; 
            padding: 8px 0; 
            color: var(--subtle-text-color); 
            font-size: 1.2em; 
            min-height: 1.6em; 
            text-transform: uppercase; 
            font-weight: normal;
            letter-spacing: 0.05em;
        }
        .loading { color: var(--secondary-color); }
        .error { color: var(--danger-color); }
        .placeholder-text { color: var(--subtle-text-color); text-align: center; padding: 15px 0; font-size: 0.95em; line-height: 1.4; }

        /* Loading animation styles */
        @keyframes dots-animation {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
            100% { content: '.'; }
        }
        .loading-dots::after {
            content: '.';
            display: inline-block;
            width: 20px;
            text-align: left;
            animation: dots-animation 1.2s infinite steps(1);
        }
        .search-animation-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }
        @keyframes book-search {
            0% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0); }
        }
        .search-icon {
            display: inline-block;
            margin-right: 8px;
            animation: book-search 1.2s infinite ease-in-out;
        }

        #pollShareArea {
            margin-top: 20px; padding: 15px; background-color: rgba(0,0,0,0.03);
            border: 1px solid; border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; text-align: center;
        }
        #pollShareLink {
            font-weight: normal; word-break: break-all; display: block; margin: 8px 0;
            background: var(--input-bg); padding: 8px; border: 1px solid;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
            border-style: inset; border-width: 2px; color: var(--primary-color);
            text-decoration: none; font-size: 0.95em;
        }
        #pollShareLink:hover { background-color: #fff; }
        #pollShareArea button { font-size: 0.95em; padding: 6px 15px; height: 30px; padding-top: 5px; }

        .admin-action-buttons { text-align: center; margin-top: 25px; }
        #copyStatus, #startPollStatus {
            min-height: 1.3em; margin-top: 5px; font-size: 0.9em; text-align: center;
        }

        #adminArea { display: block; }
        #pollView { display: none; }

        .placeholder-svg { display: block; flex-shrink: 0; border: none !important; background-color: var(--border-color); }
        .placeholder-svg rect { fill: none; }
        .placeholder-svg path, .placeholder-svg circle { stroke: var(--subtle-text-color); fill: var(--subtle-text-color); }
        .manual-placeholder-svg text { font-family: var(--font-retro); fill: var(--text-color); }

        #editBookModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        #editBookModal.active {
            opacity: 1; pointer-events: auto;
        }
        .modal-content {
            background-color: var(--card-bg); padding: 25px;
            width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto;
            border: 2px outset; position: relative;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0; font-size: 1.4em; text-transform: uppercase;
            color: var(--primary-color); font-weight: normal;
        }
        .modal-close {
            background: none; border: none; font-size: 1.8em; cursor: pointer; 
            height: 30px; width: 30px; line-height: 0.8; padding: 0;
        }
        .modal-form { display: flex; flex-direction: column; }
        .modal-form label { margin-top: 15px; margin-bottom: 5px; }
        .modal-form input, .modal-form textarea {
            margin-bottom: 15px; padding: 8px 10px;
        }
        .link-options-container {
            border: 1px solid var(--border-color);
            padding: 12px;
            margin-bottom: 15px;
            background-color: rgba(0,0,0,0.02);
        }
        .link-option {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .link-option label {
            margin: 0 10px 0 0;
            min-width: 80px;
        }
        .link-option input[type="checkbox"] {
            margin-right: 8px;
        }
        .link-option input[type="url"] {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .read-only-link {
            flex-grow: 1;
            padding: 8px 10px;
            background-color: #e5e1d8;
            border: 1px solid;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
            border-style: inset;
            border-width: 2px;
            font-family: var(--font-retro);
            font-size: 1em;
            color: var(--subtle-text-color);
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .modal-actions {
            display: flex; justify-content: space-between; margin-top: 20px;
        }
        
        /* Mobile Responsive Improvements */
        @media (max-width: 600px) {
            body { padding: 15px 10px; }
            .container { padding: 15px; }
            h1 { font-size: 2em; }
            #selectedBooksList { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
            .selected-card { padding: 12px 10px; }
            .selected-card .card-actions { gap: 5px; }
            .selected-card .card-actions button { padding: 4px 8px; font-size: 0.85em; }
            .poll-options { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
            .poll-option-card { padding: 15px 10px; }
            #manualEntryForm { flex-direction: column; width: 100%; }
            .manual-field-group { width: 100%; }
            #manualTitleInput, #manualAuthorInput, #manualLinkInput { width: 100%; }
            #addManualEntryBtn { align-self: center; width: 100%; margin-left: 0; margin-top: 10px; }
        }
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAPi4OmZieXOwy3fDhXPPt9ac_KCE0_hkw",
            authDomain: "book-klubben-236e1.firebaseapp.com",
            databaseURL: "https://book-klubben-236e1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "book-klubben-236e1",
            storageBucket: "book-klubben-236e1.appspot.com",
            messagingSenderId: "245694652120",
            appId: "1:245694652120:web:f550759de576dea4c7c1ad"
        };

        let app, database;
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log("Firebase Initialized Successfully");
        } catch (e) {
            console.error("FIREBASE INIT ERROR:", e);
            document.body.innerHTML = `<div style="padding: 20px; background-color: #fdd; border: 2px solid red; color: black; font-family: monospace;"><h1>FATAL ERROR</h1><p>Could not initialize Firebase. Check the <code>firebaseConfig</code> object.</p><p><strong>Error Details:</strong> ${e.message}</p><p>See console (F12) for more details.</p></div>`;
            throw e;
        }

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const searchResultsDiv = document.getElementById('searchResults');
        const searchStatusDiv = document.getElementById('searchStatus');
        const manualTitleInput = document.getElementById('manualTitleInput');
        const manualAuthorInput = document.getElementById('manualAuthorInput');
        const manualLinkInput = document.getElementById('manualLinkInput');
        const manualAddStatusDiv = document.getElementById('manualAddStatus');
        const selectedBooksListDiv = document.getElementById('selectedBooksList');
        const startPollBtn = document.getElementById('startPollBtn');
        const startPollStatus = document.getElementById('startPollStatus');
        const pollShareArea = document.getElementById('pollShareArea');
        const pollShareLink = document.getElementById('pollShareLink');
        const copyStatusDiv = document.getElementById('copyStatus');
        const adminAreaDiv = document.getElementById('adminArea');
        const pollViewDiv = document.getElementById('pollView');
        const pollTitleH1 = document.getElementById('pollTitle');
        const pollOptionsDiv = document.getElementById('pollOptions');
        const pollVoteStatusDiv = document.getElementById('pollVoteStatus');
        const closeSearchBtn = document.getElementById('closeSearchBtn');
        const revealVotesArea = document.getElementById('revealVotesArea');
        const revealVotesBtn = document.getElementById('revealVotesBtn');
        const pollBooksTextarea = document.getElementById('pollBooksTextarea');

        // State
        let selectedBooks = [];
        let searchTimeoutId = null;
        let currentPollId = null;
        let currentPollData = null;
        let pollDataListener = null;
        let votesRevealed = false;

        // Placeholders
        const searchResultPlaceholderSvg = `<svg width="30" height="45" viewBox="0 0 30 45" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="30" height="45"/><path d="M10 37H20" stroke="#6c6a64" stroke-width="1.2" /><path d="M10 33H20" stroke="#6c6a64" stroke-width="1.2" /><path d="M15 29C17.5 29 19.5 27 19.5 24.5C19.5 22 17.5 20 15 20C12.5 20 10.5 22 10.5 24.5C10.5 25.5 10.9 26.5 11.5 27.2" stroke="#6c6a64" stroke-width="1.2" /><path d="M15 29V31" stroke="#6c6a64" stroke-width="1.2" /><circle cx="15" cy="33" r="0.8" fill="#6c6a64"/></svg>`;
        const selectedListPlaceholderSvg = `<svg width="85" height="128" viewBox="0 0 85 128" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="85" height="128"/><path d="M30 105H55" stroke="#6c6a64" stroke-width="1.5" /><path d="M30 95H55" stroke="#6c6a64" stroke-width="1.5"/><path d="M42.5 85C47.5 85 52 80.5 52 75.5C52 70.5 47.5 66 42.5 66C37.5 66 33 70.5 33 75.5C33 78 34 80 35 81.5" stroke="#6c6a64" stroke-width="1.8" /><path d="M42.5 85V90" stroke="#6c6a64" stroke-width="1.8" /><circle cx="42.5" cy="95" r="1.8" fill="#6c6a64"/></svg>`;

        function generateManualPlaceholderSvg(title = "Manual Entry") {
            let displayText = title.replace(/</g, '').replace(/>/g, '');
            if (displayText.length > 15) displayText = displayText.substring(0, 14) + '…';
            let displayText2 = "";
            if (title.length > 15) {
                displayText2 = title.substring(15);
                if (displayText2.length > 15) displayText2 = displayText2.substring(0, 14) + '…';
            }
            return `<svg width="85" height="128" viewBox="0 0 85 128" fill="none" xmlns="http://www.w3.org/2000/svg" class="manual-placeholder-svg">
                        <rect x="1" y="1" width="83" height="126" fill="#e0dccf" stroke="#a09c91" stroke-width="1"/>
                        <rect x="10" y="15" width="65" height="22" fill="#f0ede6" />
                        <text x="15" y="30" font-size="14px" text-anchor="start">${escapeHtmlBasic(displayText)}</text>
                        ${displayText2 ? `<text x="15" y="50" font-size="14px" text-anchor="start">${escapeHtmlBasic(displayText2)}</text>` : ''}
                        <rect x="10" y="85" width="65" height="4" fill="#c88e37" />
                        <rect x="10" y="100" width="65" height="4" fill="#a09c91" />
                    </svg>`;
        }

        // Utility Functions
        function debounce(func, delay) {
            return function (...args) {
                clearTimeout(searchTimeoutId);
                searchTimeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function getPollIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('pollId');
        }

        function sanitizeKey(key) {
            return key.replace(/[.$#[\]/]/g, '_');
        }

        function createUniqueKey(prefix = 'key_') {
            return prefix + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        }

        function escapeHtmlBasic(str) {
            if (typeof str !== 'string') str = String(str || '');
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        // Search Functionality
        async function performSearch() {
            const query = searchInput.value.trim();
            searchResultsDiv.innerHTML = '';
            if (!query) {
                searchStatusDiv.textContent = '';
                return;
            }
            searchStatusDiv.innerHTML = `
                <span class="loading">
                    <span class="search-icon">📚</span>
                    SEARCHING<span class="loading-dots"></span>
                </span>
            `;
            const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=6&fields=key,title,author_name,cover_i,number_of_pages_median,isbn`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                searchStatusDiv.textContent = '';
                displaySearchResults(data.docs);
            } catch (error) {
                console.error('Search Error:', error);
                searchStatusDiv.innerHTML = '<span class="error">⚠️ SEARCH FAILED</span>';
                searchResultsDiv.innerHTML = '';
            }
        }

        const debouncedSearch = debounce(performSearch, 450);
        searchInput.addEventListener('input', debouncedSearch);

        function displaySearchResults(books) {
            searchResultsDiv.innerHTML = '';
            if (!books || books.length === 0) {
                searchResultsDiv.innerHTML = '<p class="placeholder-text">[[ No Matches ]]</p>';
                return;
            }
            books.forEach(book => {
                const title = book.title || '???';
                const authors = book.author_name ? book.author_name.join(', ') : '???';
                const coverId = book.cover_i;
                const coverHtml = coverId ? `<img src="https://covers.openlibrary.org/b/id/${coverId}-S.jpg" alt="" loading="lazy">` : searchResultPlaceholderSvg;
                const pageCount = book.number_of_pages_median || 'N/A';
                const bookKey = book.key;
                const isbn = book.isbn ? book.isbn[0] : null;
                const isSelected = selectedBooks.some(b => b.key === bookKey);

                const bookElement = document.createElement('div');
                bookElement.className = `book-item${isSelected ? ' selected' : ''}`;
                bookElement.dataset.key = bookKey;
                bookElement.innerHTML = `
                    ${coverHtml}
                    <div class="book-info">
                        <strong>${escapeHtmlBasic(title)}</strong>
                        <p>by ${escapeHtmlBasic(authors)}</p>
                    </div>
                `;
                const button = document.createElement('button');
                button.textContent = isSelected ? '.Sel.' : '+ Add';
                if (isSelected) button.disabled = true;
                button.addEventListener('click', () => selectBook(button, bookKey, title, authors, coverId, pageCount, isbn));
                bookElement.appendChild(button);
                searchResultsDiv.appendChild(bookElement);
            });
        }

        closeSearchBtn.addEventListener('click', () => {
            searchResultsDiv.innerHTML = '';
            searchStatusDiv.textContent = '';
        });

        // Manual Book Addition
        function addManualEntry() {
            const title = manualTitleInput.value.trim();
            const author = manualAuthorInput.value.trim() || "N/A";
            const link = manualLinkInput.value.trim();
            manualAddStatusDiv.textContent = '';

            if (!title) {
                manualAddStatusDiv.textContent = 'TITLE NEEDED';
                manualTitleInput.focus();
                return;
            }
            if (link && !link.match(/^https?:\/\//)) {
                manualAddStatusDiv.textContent = 'INVALID URL (use http/https)';
                manualLinkInput.focus();
                return;
            }
            const alreadyExists = selectedBooks.some(b =>
                b.isManual && b.title.toLowerCase() === title.toLowerCase() && b.authors.toLowerCase() === author.toLowerCase()
            );
            if (alreadyExists) {
                manualAddStatusDiv.textContent = 'DUPLICATE';
                return;
            }

            const manualKey = createUniqueKey('manual_');
            const bookData = {
                key: manualKey,
                title: title,
                authors: author,
                link: link || '',
                isCustom: true,
                isFreeform: false,
                isManual: true,
                coverId: null,
                pageCount: 'N/A',
                isbn: null,
                votes: 0
            };
            selectedBooks.push(bookData);
            displaySelectedBooksAdmin();
            manualTitleInput.value = '';
            manualAuthorInput.value = '';
            manualLinkInput.value = '';
            manualTitleInput.focus();
        }

        document.getElementById('manualEntryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            addManualEntry();
        });

        // Selection (Admin View)
        function selectBook(buttonElement, key, title, authors, coverId, pageCount, isbn) {
            if (selectedBooks.some(b => b.key === key)) return;

            const openLibraryLink = key.startsWith('/works/') ? `https://openlibrary.org${key}` : '';
            const bookData = {
                key: key,
                title: title,
                authors: authors,
                coverId: coverId || null,
                pageCount: pageCount,
                isbn: isbn || null,
                isCustom: false,
                isFreeform: false,
                isManual: false,
                link: openLibraryLink,
                votes: 0
            };
            selectedBooks.push(bookData);
            displaySelectedBooksAdmin();

            buttonElement.textContent = '.Sel.';
            buttonElement.disabled = true;
            const bookItem = buttonElement.closest('.book-item');
            if (bookItem) bookItem.classList.add('selected');
        }

        function removeBook(keyToRemove) {
            selectedBooks = selectedBooks.filter(book => book.key !== keyToRemove);
            displaySelectedBooksAdmin();
            const bookItemInSearch = searchResultsDiv.querySelector(`.book-item[data-key="${keyToRemove}"]`);
            if (bookItemInSearch) {
                const btn = bookItemInSearch.querySelector('button');
                if (btn) {
                    btn.textContent = '+ Add';
                    btn.disabled = false;
                }
                bookItemInSearch.classList.remove('selected');
            }
        }

        function generateLinksHtmlAdmin(book) {
            if (book.isManual) return `<div class="links">${book.link ? `<a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">User Link</a>` : ''}</div>`;
            
            let links = [];
            
            // Add OpenLibrary link if enabled
            if (book.olLinkEnabled || (book.link && book.link.includes('openlibrary.org') && book.olLinkEnabled !== false)) {
                links.push(`<a href="${book.link}" target="_blank" rel="noopener">OL</a>`);
            } 
            // Add user link if enabled
            else if (book.userLinkEnabled || (book.link && !book.link.includes('openlibrary.org') && book.userLinkEnabled !== false)) {
                links.push(`<a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">Link</a>`);
            }
            
            // Add Goodreads link only if enabled
            if (book.grLinkEnabled && book.customGoodreadsLink) {
                links.push(`<a href="${escapeHtmlBasic(book.customGoodreadsLink)}" target="_blank" rel="noopener">GR</a>`);
            } else if (book.grLinkEnabled !== false && book.customGoodreadsLink !== null) {
                const goodreadsQuery = book.isbn ? book.isbn : `${book.title} ${book.authors}`;
                const goodreadsSearchLink = `https://www.goodreads.com/search?q=${encodeURIComponent(goodreadsQuery)}`;
                const showGr = book.isbn || (book.title && book.title !== '???' && book.authors && book.authors !== '???');
                
                if (showGr) {
                    links.push(`<a href="${goodreadsSearchLink}" target="_blank" rel="noopener">GR</a>`);
                }
            }
            
            return `<div class="links">${links.join(' | ')}</div>`;
        }

        function displaySelectedBooksAdmin() {
            selectedBooksListDiv.innerHTML = '';
            pollShareArea.style.display = 'none';
            copyStatusDiv.textContent = '';
            pollBooksTextarea.value = '';

            const hasBooks = selectedBooks.length > 0;
            startPollBtn.disabled = !hasBooks;

            if (!hasBooks) {
                selectedBooksListDiv.innerHTML = '<p class="placeholder-text"></p>';
                return;
            }

            selectedBooks.forEach(book => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('selected-card');
                let coverHtml = '';

                if (book.isManual) {
                    cardElement.classList.add('manual-entry');
                    coverHtml = generateManualPlaceholderSvg(book.title);
                    const manualLinkHtml = book.link
                        ? `<div class="links"><a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">User Link</a></div>`
                        : '<div class="links"></div>';
                    cardElement.innerHTML = `
                        ${coverHtml}
                        <h3>${escapeHtmlBasic(book.title)}</h3>
                        <p><em>${escapeHtmlBasic(book.authors)}</em></p>
                        <p>(Manual)</p>
                        ${manualLinkHtml}
                        <div class="card-actions"></div>
                    `;
                } else {
                    coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-M.jpg" alt="${escapeHtmlBasic(book.title)}" loading="lazy">` : selectedListPlaceholderSvg;
                    const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount}p` : '';
                    const linksHtml = generateLinksHtmlAdmin(book);
                    cardElement.innerHTML = `
                        ${coverHtml}
                        <h3>${escapeHtmlBasic(book.title)}</h3>
                        <p><em>${escapeHtmlBasic(book.authors)}</em></p>
                        ${pageCountDisplay ? `<p>${pageCountDisplay}</p>` : ''}
                        ${linksHtml}
                        <div class="card-actions"></div>
                    `;
                }

                const actionsDiv = cardElement.querySelector('.card-actions');
                
                // Add Edit button
                const editButton = document.createElement('button');
                editButton.className = 'btn-edit';
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', () => openEditModal(book));
                actionsDiv.appendChild(editButton);
                
                const removeButton = document.createElement('button');
                removeButton.className = 'btn-remove';
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => removeBook(book.key));
                actionsDiv.appendChild(removeButton);

                selectedBooksListDiv.appendChild(cardElement);
            });
        }

        // Poll Creation with Automatic Book Info Textarea
        async function startPoll() {
            if (!database) {
                startPollStatus.textContent = "DB ERROR";
                return;
            }
            if (selectedBooks.length === 0) {
                startPollStatus.textContent = "NEED BOOKS";
                return;
            }
            startPollStatus.textContent = "";
            startPollBtn.disabled = true;
            startPollBtn.textContent = "Working...";
            pollShareArea.style.display = 'none';

            const pollOptions = {};
            selectedBooks.forEach(book => {
                const safeKey = sanitizeKey(book.key);
                pollOptions[safeKey] = {
                    title: book.title,
                    author: book.authors,
                    pageCount: book.pageCount,
                    link: book.link,
                    isbn: book.isbn,
                    coverId: book.coverId,
                    isCustom: book.isCustom,
                    isManual: book.isManual || false,
                    customGoodreadsLink: book.customGoodreadsLink || null,
                    olLinkEnabled: book.link && book.link.includes('openlibrary.org'),
                    userLinkEnabled: book.link && !book.link.includes('openlibrary.org'),
                    grLinkEnabled: book.customGoodreadsLink !== null,
                    votes: 0
                };
            });
            const dateStr = new Date().toISOString().split('T')[0];
            const pollTitle = `BOOK VOTE ${dateStr}`;
            const pollData = { title: pollTitle, options: pollOptions, createdAt: Date.now() };

            try {
                const newPollRef = ref(database, 'polls');
                const newPoll = await push(newPollRef);
                await set(newPoll, pollData);
                currentPollId = newPoll.key;
                const baseUrl = window.location.href.split('?')[0].split('#')[0];
                const shareUrl = `${baseUrl}?pollId=${currentPollId}`;
                pollShareLink.textContent = shareUrl;
                pollShareLink.href = shareUrl;

                // Generate book info text with sanitization
                let booksText = '';
                try {
                    booksText = selectedBooks.map(book => {
                        const title = escapeHtmlBasic(book.title || "Unknown Title");
                        const author = escapeHtmlBasic(book.authors || "Unknown Author");
                        let bestLink = '';
                        if (book.isManual && book.link) {
                            bestLink = escapeHtmlBasic(book.link);
                        } else if (book.isbn) {
                            bestLink = `https://www.goodreads.com/search?q=${encodeURIComponent(book.isbn)}`;
                        } else if (!book.isManual && book.link) {
                            bestLink = escapeHtmlBasic(book.link);
                        }
                        return bestLink ? `${title} - ${author}\nLink: ${bestLink}` : `${title} - ${author}`;
                    }).join('\n\n');
                } catch (error) {
                    console.error("Error generating book info text:", error);
                    booksText = "Error generating book info.";
                }

                pollBooksTextarea.value = booksText;
                pollShareArea.style.display = 'block';
                startPollBtn.textContent = "Poll Ready!";
                copyStatusDiv.textContent = "";
                startPollStatus.textContent = "";
            } catch (error) {
                console.error("Poll Start Error:", error);
                startPollStatus.textContent = "POLL ERR";
                startPollBtn.disabled = false;
                startPollBtn.textContent = "MAKE_POLL";
            }
        }

        startPollBtn.addEventListener('click', startPoll);

        function copyPollLink() {
            const link = pollShareLink.textContent;
            try {
                navigator.clipboard.writeText(link).then(() => {
                    copyStatusDiv.textContent = "POLL LINK COPIED!";
                    copyStatusDiv.style.color = 'var(--success-color)';
                    setTimeout(() => { copyStatusDiv.textContent = ''; }, 2500);
                }).catch(err => {
                    console.error('Clipboard Error:', err);
                    copyStatusDiv.textContent = "COPY FAILED";
                    copyStatusDiv.style.color = 'var(--danger-color)';
                });
            } catch (err) {
                console.error('Clipboard API not supported:', err);
                copyStatusDiv.textContent = "COPY UNSUPPORTED";
                copyStatusDiv.style.color = 'var(--danger-color)';
            }
        }

        pollShareArea.querySelector('button').addEventListener('click', copyPollLink);

        // Poll Loading & Display
        function loadPoll(pollId) {
            if (!database) {
                pollTitleH1.textContent = "DATABASE ERROR";
                pollOptionsDiv.innerHTML = '<p class="placeholder-text error">[[ Cannot connect to Database ]]</p>';
                return;
            }
            adminAreaDiv.style.display = 'none';
            pollViewDiv.style.display = 'block';
            votesRevealed = false;
            pollViewDiv.classList.remove('votes-revealed');
            revealVotesArea.style.display = 'none';
            revealVotesBtn.disabled = false;
            revealVotesBtn.textContent = 'Reveal Votes';

            const pollRef = ref(database, `polls/${pollId}`);
            if (pollDataListener) pollDataListener();

            pollTitleH1.textContent = "LOAD POLL...";
            pollOptionsDiv.innerHTML = '<p class="placeholder-text">[[ Waiting For Data ]]</p>';

            pollDataListener = onValue(pollRef, (snapshot) => {
                if (!snapshot.exists()) {
                    pollTitleH1.textContent = "POLL NOT FOUND";
                    pollOptionsDiv.innerHTML = '<p class="placeholder-text error">[[ Invalid Poll ID ]]</p>';
                    revealVotesArea.style.display = 'none';
                    console.error("Poll data not found for ID:", pollId);
                    return;
                }
                currentPollData = snapshot.val();
                pollTitleH1.textContent = currentPollData.title || "BOOK VOTE";
                pollOptionsDiv.innerHTML = '';
                
                // Log the poll data for debugging
                console.log("Loaded poll data:", currentPollData);

                const existingCards = pollOptionsDiv.querySelectorAll('.poll-option-card.winner');
                existingCards.forEach(card => card.classList.remove('winner'));

                if (!currentPollData.options || Object.keys(currentPollData.options).length === 0) {
                    pollOptionsDiv.innerHTML = '<p class="placeholder-text">[[ No Books In Poll ]]</p>';
                    revealVotesArea.style.display = 'none';
                    return;
                }

                revealVotesArea.style.display = 'block';

                Object.entries(currentPollData.options).forEach(([key, book]) => {
                    const cardElement = document.createElement('div');
                    cardElement.classList.add('poll-option-card');
                    cardElement.dataset.key = key;

                    let coverHtml = '';
                    const voteCount = book.votes || 0;
                    let linksHtml = '';

                    if (book.isManual) {
                        coverHtml = generateManualPlaceholderSvg(book.title);
                        linksHtml = book.link && book.userLinkEnabled !== false
                            ? `<div class="links"><a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">User Link</a></div>`
                            : '<div class="links"></div>';
                        cardElement.innerHTML = `
                            <div class="poll-card-content">
                                ${coverHtml}
                                <h4>${escapeHtmlBasic(book.title)}</h4>
                                <p><em>${escapeHtmlBasic(book.author)}</em></p>
                                <p>(Manual)</p>
                                ${linksHtml}
                            </div>
                            <div class="vote-area">
                                <span class="vote-count" id="votes-${key}">${voteCount} Votes</span>
                            </div>
                        `;
                    } else {
                        coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-M.jpg" alt="${escapeHtmlBasic(book.title)}" loading="lazy">`
                            : selectedListPlaceholderSvg;
                        const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount}p` : '';
                        linksHtml = generateLinksHtmlVoter(book);
                        cardElement.innerHTML = `
                            <div class="poll-card-content">
                                ${coverHtml}
                                <h4>${escapeHtmlBasic(book.title)}</h4>
                                <p><em>${escapeHtmlBasic(book.author)}</em></p>
                                ${pageCountDisplay ? `<p>${pageCountDisplay}</p>` : ''}
                                ${linksHtml}
                            </div>
                            <div class="vote-area">
                                <span class="vote-count" id="votes-${key}">${voteCount} Votes</span>
                            </div>
                        `;
                    }
                    const voteArea = cardElement.querySelector('.vote-area');
                    const voteButton = document.createElement('button');
                    voteButton.className = 'btn-vote';
                    voteButton.id = `btn-${key}`;
                    voteButton.textContent = 'Vote';
                    voteButton.addEventListener('click', () => castVote(key));
                    voteArea.appendChild(voteButton);
                    pollOptionsDiv.appendChild(cardElement);
                });

                if (votesRevealed) applyWinnerHighlighting();
                checkIfVoted();
            }, (error) => {
                console.error("Firebase poll read failed:", error);
                pollTitleH1.textContent = "ERROR LOADING POLL";
                pollOptionsDiv.innerHTML = '<p class="placeholder-text error">[[ Could not load poll data ]]</p>';
                pollVoteStatusDiv.textContent = "LOAD ERROR";
                pollVoteStatusDiv.style.color = "var(--danger-color)";
                revealVotesArea.style.display = 'none';
            });
        }

        function generateLinksHtmlVoter(book) {
            if (book.isManual) return `<div class="links">${book.link ? `<a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">User Link</a>` : ''}</div>`;
            
            let links = [];
            
            // Add OpenLibrary link if enabled
            if (book.olLinkEnabled || (book.link && book.link.includes('openlibrary.org') && book.olLinkEnabled !== false)) {
                links.push(`<a href="${book.link}" target="_blank" rel="noopener">OL</a>`);
            } 
            // Add user link if enabled
            else if (book.userLinkEnabled || (book.link && !book.link.includes('openlibrary.org') && book.userLinkEnabled !== false)) {
                links.push(`<a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">Link</a>`);
            }
            
            // Add Goodreads link only if enabled
            if (book.grLinkEnabled && book.customGoodreadsLink) {
                links.push(`<a href="${escapeHtmlBasic(book.customGoodreadsLink)}" target="_blank" rel="noopener">GR</a>`);
            } else if (book.grLinkEnabled !== false && book.customGoodreadsLink !== null) {
                const goodreadsQuery = book.isbn ? book.isbn : `${book.title} ${book.author}`;
                const goodreadsSearchLink = `https://www.goodreads.com/search?q=${encodeURIComponent(goodreadsQuery)}`;
                const showGr = book.isbn || (book.title && book.title !== '???' && book.author && book.author !== '???');
                
                if (showGr) {
                    links.push(`<a href="${goodreadsSearchLink}" target="_blank" rel="noopener">GR</a>`);
                }
            }
            
            return `<div class="links">${links.join(' | ')}</div>`;
        }

        // Voting
        async function castVote(bookKey) {
            if (!database) {
                pollVoteStatusDiv.textContent = "DB ERROR";
                return;
            }
            if (!currentPollId || votesRevealed) return;

            const votedPollKey = `voted_${currentPollId}`;
            if (localStorage.getItem(votedPollKey)) {
                pollVoteStatusDiv.textContent = "VOTED ALREADY";
                pollVoteStatusDiv.style.color = "var(--secondary-color)";
                disableAllVoteButtons();
                setTimeout(() => { pollVoteStatusDiv.textContent = checkIfVoted() ? "VOTED" : ''; }, 3000);
                return;
            }
            disableAllVoteButtons();
            pollVoteStatusDiv.textContent = "VOTING...";
            pollVoteStatusDiv.style.color = "var(--primary-color)";
            try {
                const votePath = `polls/${currentPollId}/options/${bookKey}`;
                await update(ref(database, votePath), { votes: (currentPollData.options[bookKey].votes || 0) + 1 });
                pollVoteStatusDiv.textContent = "VOTE OK";
                pollVoteStatusDiv.style.color = "var(--success-color)";
                localStorage.setItem(votedPollKey, bookKey);
                checkIfVoted();
            } catch (error) {
                console.error("Vote Error:", error);
                pollVoteStatusDiv.textContent = "VOTE ERR";
                pollVoteStatusDiv.style.color = "var(--danger-color)";
                checkIfVoted();
            }
            setTimeout(() => { pollVoteStatusDiv.textContent = checkIfVoted() ? "VOTED" : ''; }, 3000);
        }

        function disableAllVoteButtons() {
            const buttons = pollOptionsDiv.querySelectorAll('.btn-vote');
            buttons.forEach(button => button.disabled = true);
        }

        function checkIfVoted() {
            if (!currentPollId) return false;
            const votedPollKey = `voted_${currentPollId}`;
            const hasVoted = localStorage.getItem(votedPollKey);
            const buttons = pollOptionsDiv.querySelectorAll('.btn-vote');

            if (hasVoted || votesRevealed) {
                buttons.forEach(button => button.disabled = true);
                if (hasVoted && (!pollVoteStatusDiv.textContent || pollVoteStatusDiv.textContent === "VOTING...")) {
                    pollVoteStatusDiv.textContent = "VOTED";
                    pollVoteStatusDiv.style.color = "var(--subtle-text-color)";
                }
                return true;
            } else {
                buttons.forEach(button => button.disabled = false);
                if (pollVoteStatusDiv.textContent === "VOTED") pollVoteStatusDiv.textContent = "";
                return false;
            }
        }

        // Reveal Votes
        function revealVotes() {
            if (!currentPollData || !currentPollData.options || votesRevealed) return;
            votesRevealed = true;
            pollViewDiv.classList.add('votes-revealed');
            applyWinnerHighlighting();
            revealVotesBtn.textContent = 'Results Shown';
            revealVotesBtn.disabled = true;
            disableAllVoteButtons();
            if (!localStorage.getItem(`voted_${currentPollId}`)) {
                pollVoteStatusDiv.textContent = "POLL CLOSED";
                pollVoteStatusDiv.style.color = "var(--subtle-text-color)";
            }
        }

        revealVotesBtn.addEventListener('click', revealVotes);

        function applyWinnerHighlighting() {
            if (!currentPollData || !currentPollData.options) return;
            let maxVotes = -1;
            Object.values(currentPollData.options).forEach(book => {
                maxVotes = Math.max(maxVotes, book.votes || 0);
            });

            const allCards = pollOptionsDiv.querySelectorAll('.poll-option-card');
            allCards.forEach(card => card.classList.remove('winner'));

            if (maxVotes > 0) {
                Object.entries(currentPollData.options).forEach(([key, book]) => {
                    if ((book.votes || 0) === maxVotes) {
                        const winnerCard = pollOptionsDiv.querySelector(`.poll-option-card[data-key="${key}"]`);
                        if (winnerCard) winnerCard.classList.add('winner');
                    }
                });
            }
        }

        // Initialization
        window.addEventListener('load', () => {
            if (!database) {
                console.error("Database not initialized");
                document.body.innerHTML = '<div style="color: red; padding: 20px;">Error: Could not connect to database. Please try again later.</div>';
                return;
            }
            currentPollId = getPollIdFromUrl();
            if (currentPollId) {
                loadPoll(currentPollId);
            } else {
                adminAreaDiv.style.display = 'block';
                pollViewDiv.style.display = 'none';
                displaySelectedBooksAdmin();
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (pollDataListener && currentPollId) pollDataListener();
        });

        // Edit Modal Functionality
        const editBookModal = document.getElementById('editBookModal');
        const editBookForm = document.getElementById('editBookForm');
        const editBookKey = document.getElementById('editBookKey');
        const editTitleInput = document.getElementById('editTitleInput');
        const editAuthorInput = document.getElementById('editAuthorInput');
        const editLinkInput = document.getElementById('editLinkInput');
        const editCustomLinkEnabled = document.getElementById('editCustomLinkEnabled');
        const editOlLinkInput = document.getElementById('editOlLinkInput');
        const editOlLinkDisplay = document.getElementById('editOlLinkDisplay');
        const editOlLinkEnabled = document.getElementById('editOlLinkEnabled');
        const editGrLinkInput = document.getElementById('editGrLinkInput');
        const editGrLinkDisplay = document.getElementById('editGrLinkDisplay');
        const editGrLinkEnabled = document.getElementById('editGrLinkEnabled');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const modalCloseBtn = document.querySelector('.modal-close');

        // Toggle link input fields based on checkbox state
        editCustomLinkEnabled.addEventListener('change', function() {
            editLinkInput.disabled = !this.checked;
            if (!this.checked) editLinkInput.value = '';
        });
        
        editOlLinkEnabled.addEventListener('change', function() {
            editOlLinkDisplay.style.opacity = this.checked ? '1' : '0.5';
        });
        
        editGrLinkEnabled.addEventListener('change', function() {
            editGrLinkDisplay.style.opacity = this.checked ? '1' : '0.5';
        });

        function openEditModal(book) {
            editBookKey.value = book.key;
            editTitleInput.value = book.title || '';
            editAuthorInput.value = book.authors || '';

            // Reset all link fields
            editLinkInput.value = '';
            editOlLinkInput.value = '';
            editGrLinkInput.value = '';
            editOlLinkDisplay.textContent = '';
            editGrLinkDisplay.textContent = '';
            
            // Handle User Link
            editCustomLinkEnabled.checked = !!book.link && !(book.link && book.link.includes('openlibrary.org'));
            editLinkInput.disabled = !editCustomLinkEnabled.checked;
            
            // Handle OpenLibrary Link
            if (book.link && !book.isManual && book.link.includes('openlibrary.org')) {
                // This is an OpenLibrary link
                editOlLinkEnabled.checked = true;
                editOlLinkDisplay.style.opacity = '1';
                editOlLinkDisplay.textContent = book.link;
                editOlLinkInput.value = book.link;
            } else {
                editOlLinkEnabled.checked = false;
                editOlLinkDisplay.style.opacity = '0.5';
                editOlLinkDisplay.textContent = 'OpenLibrary link will be auto-detected';
                editOlLinkInput.value = '';
            }
            
            // Custom link for manual books or any other custom link
            if (book.link && (book.isManual || !book.link.includes('openlibrary.org'))) {
                editLinkInput.value = book.link;
            }
            
            // Handle Goodreads Link
            if (book.customGoodreadsLink) {
                // Use the custom Goodreads link if it exists
                editGrLinkEnabled.checked = true;
                editGrLinkDisplay.style.opacity = '1';
                editGrLinkDisplay.textContent = book.customGoodreadsLink;
                editGrLinkInput.value = book.customGoodreadsLink;
            } else {
                // Create a default Goodreads link or not, based on available info
                let grLink = '';
                if (book.isbn) {
                    grLink = `https://www.goodreads.com/search?q=${encodeURIComponent(book.isbn)}`;
                } else if (book.title && book.authors) {
                    grLink = `https://www.goodreads.com/search?q=${encodeURIComponent(`${book.title} ${book.authors}`)}`;
                }
                
                editGrLinkEnabled.checked = !!grLink;
                editGrLinkDisplay.style.opacity = editGrLinkEnabled.checked ? '1' : '0.5';
                
                if (grLink) {
                    editGrLinkDisplay.textContent = grLink;
                    editGrLinkInput.value = grLink;
                } else {
                    editGrLinkDisplay.textContent = 'Auto-generated Goodreads search link';
                }
            }
            
            editBookModal.classList.add('active');
            editTitleInput.focus();
        }

        function closeEditModal() {
            editBookModal.classList.remove('active');
            editBookForm.reset();
            
            // Reset displayed states
            editLinkInput.disabled = false;
            editOlLinkDisplay.style.opacity = '0.5';
            editGrLinkDisplay.style.opacity = '0.5';
        }

        editBookForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const key = editBookKey.value;
            const title = editTitleInput.value.trim();
            const author = editAuthorInput.value.trim() || 'N/A';
            
            // Get link values based on checkboxes
            let primaryLink = '';
            let grLink = null; // Set to null by default to ensure links can be deleted
            
            if (editCustomLinkEnabled.checked && editLinkInput.value.trim()) {
                primaryLink = editLinkInput.value.trim();
            } else if (editOlLinkEnabled.checked && editOlLinkInput.value.trim()) {
                primaryLink = editOlLinkInput.value.trim();
            } else {
                // Explicitly set to empty string if no link is enabled
                primaryLink = '';
            }
            
            if (editGrLinkEnabled.checked && editGrLinkInput.value.trim()) {
                grLink = editGrLinkInput.value.trim();
            } else {
                // Explicitly set to null if Goodreads checkbox is unchecked
                grLink = null;
            }

            if (!title) {
                alert('Title is required');
                editTitleInput.focus();
                return;
            }

            if (editCustomLinkEnabled.checked && editLinkInput.value && !editLinkInput.value.match(/^https?:\/\//)) {
                alert('User link must be a valid URL starting with http:// or https://');
                editLinkInput.focus();
                return;
            }

            const bookIndex = selectedBooks.findIndex(b => b.key === key);
            if (bookIndex !== -1) {
                const book = selectedBooks[bookIndex];
                book.title = title;
                book.authors = author;
                book.link = primaryLink;
                book.customGoodreadsLink = grLink; // Will be null if checkbox unchecked
                
                // Set the link enabled states explicitly
                book.userLinkEnabled = editCustomLinkEnabled.checked;
                book.olLinkEnabled = editOlLinkEnabled.checked;
                book.grLinkEnabled = editGrLinkEnabled.checked;
                
                // Log the state after changes to verify
                console.log('Book after edit:', { 
                    title: book.title, 
                    authors: book.authors, 
                    link: book.link, 
                    customGoodreadsLink: book.customGoodreadsLink,
                    userLinkEnabled: book.userLinkEnabled,
                    olLinkEnabled: book.olLinkEnabled,
                    grLinkEnabled: book.grLinkEnabled
                });
                
                displaySelectedBooksAdmin();
                closeEditModal();
            }
        });

        cancelEditBtn.addEventListener('click', closeEditModal);
        modalCloseBtn.addEventListener('click', closeEditModal);

        // Close modal if clicking outside content
        editBookModal.addEventListener('click', (e) => {
            if (e.target === editBookModal) {
                closeEditModal();
            }
        });

        // Escape key to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && editBookModal.classList.contains('active')) {
                closeEditModal();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div id="adminArea">
            <h1>Book Klubben 🍷📚 poll_helper</h1>
            <section class="add-books-area">
                <h2></h2>
                <div class="section-content">
                    <div class="search-input-wrapper">
                        <label for="searchInput"> Search Open_Library & add books </label>
                        <input type="text" id="searchInput" placeholder="Enter Title / Author..." aria-label="Search Open Library">
                    </div>
                    <div id="searchStatus" class="status-message"></div>
                    <div class="search-results-container">
                        <div id="searchResults"></div>
                        <button id="closeSearchBtn" title="Close Search Results">X</button>
                    </div>
                    <div class="manual-add-area">
                        <form id="manualEntryForm">
                            <div class="manual-field-group">
                                <label for="manualTitleInput">Title:</label>
                                <input type="text" id="manualTitleInput" placeholder="(Required)" aria-label="Manual Book Title">
                            </div>
                            <div class="manual-field-group">
                                <label for="manualAuthorInput">Author/Info:</label>
                                <input type="text" id="manualAuthorInput" placeholder="(Optional)" aria-label="Manual Book Author">
                            </div>
                            <div class="manual-field-group">
                                <label for="manualLinkInput">Link:</label>
                                <input type="url" id="manualLinkInput" placeholder="(Optional URL)" aria-label="Manual Book Link">
                            </div>
                            <button type="submit" id="addManualEntryBtn">Add Manual</button>
                        </form>
                        <div id="manualAddStatus" class="status-message error"></div>
                    </div>
                </div>
            </section>
            <section class="selected-area">
                <h2>Selected books</h2>
                <div class="section-content">
                    <div id="selectedBooksList">
                        <p class="placeholder-text"></p>
                    </div>
                    <div class="admin-action-buttons">
                        <button id="startPollBtn">MAKE_POLL</button>
                    </div>
                    <div id="startPollStatus" class="status-message error"></div>
                    <div id="pollShareArea" style="display: none;">
                        >> Poll Ready! Share Link:
                        <a id="pollShareLink" href="#" target="_blank" rel="noopener noreferrer"></a>
                        <button style="margin-top: 10px;">Copy_Link</button>
                        <div id="copyStatus" class="status-message"></div>
                        <textarea id="pollBooksTextarea" readonly></textarea>
                    </div>
                </div>
            </section>
        </div>
        <div id="pollView">
            <h1 id="pollTitle">LOAD POLL...</h1>
            <div id="pollOptions" class="poll-options">
                <p class="placeholder-text">[[ Waiting For Data ]]</p>
            </div>
            <div id="revealVotesArea" style="display: none;">
                <button id="revealVotesBtn">Reveal Votes</button>
            </div>
            <div id="pollVoteStatus" class="status-message" style="margin-top: 15px;"></div>
        </div>
    </div>
</body>
<div id="editBookModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Book</h3>
            <button class="modal-close">&times;</button>
        </div>
        <form id="editBookForm" class="modal-form">
            <input type="hidden" id="editBookKey">
            <label for="editTitleInput">Title:</label>
            <input type="text" id="editTitleInput" required>
            <label for="editAuthorInput">Author:</label>
            <input type="text" id="editAuthorInput">
            
            <label>Link Options:</label>
            <div class="link-options-container">
                <div class="link-option">
                    <input type="checkbox" id="editCustomLinkEnabled" checked>
                    <label for="editCustomLinkEnabled">User Link:</label>
                    <input type="url" id="editLinkInput" placeholder="https://...">
                </div>
                
                <div class="link-option">
                    <input type="checkbox" id="editOlLinkEnabled">
                    <label for="editOlLinkEnabled">OpenLibrary:</label>
                    <div id="editOlLinkDisplay" class="read-only-link"></div>
                    <input type="hidden" id="editOlLinkInput">
                </div>
                
                <div class="link-option">
                    <input type="checkbox" id="editGrLinkEnabled" checked>
                    <label for="editGrLinkEnabled">Goodreads:</label>
                    <div id="editGrLinkDisplay" class="read-only-link"></div>
                    <input type="hidden" id="editGrLinkInput">
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="cancelEditBtn">Cancel</button>
                <button type="submit" id="saveEditBtn">Save Changes</button>
            </div>
        </form>
    </div>
</div>
</html>
