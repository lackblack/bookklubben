<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CHANGE THIS TITLE! -->
    <title>Book Club Voting App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Layout Styles (compacted) --- */
        :root{--bg-color:#f8f9fa;--card-bg:#fff;--primary-color:#5a8dee;--secondary-color:#f59e4b;--text-color:#212529;--subtle-text-color:#6c757d;--border-color:#dee2e6;--input-border-color:#ced4da;--card-shadow:0 2px 6px rgba(0,0,0,.06);--card-hover-shadow:0 5px 12px rgba(0,0,0,.1)}
        body{font-family:'Inter',sans-serif;line-height:1.6;margin:0;background-color:var(--bg-color);color:var(--text-color);display:flex;justify-content:center;align-items:flex-start;padding:20px 15px;min-height:100vh}
        .container{max-width:880px;width:100%;background:var(--card-bg);padding:25px 30px;border-radius:10px;box-shadow:0 5px 25px rgba(0,0,0,.07);margin:20px 0}
        h1,h2{color:var(--text-color);text-align:center;margin-bottom:20px;font-weight:500}
        h1{color:var(--primary-color);font-size:2em;margin-bottom:30px;font-weight:600}
        h2{font-size:1.35em;margin-top:35px;margin-bottom:18px;text-align:left;border-bottom:1px solid var(--border-color);padding-bottom:8px;font-weight:500;color:var(--subtle-text-color)}
        section{margin-bottom:25px;padding-bottom:10px}
        input[type="text"]{padding:10px 14px;border:1px solid var(--input-border-color);border-radius:6px;font-size:.9em;box-sizing:border-box;transition:border-color .2s ease,box-shadow .2s ease;background-color:#fff;margin-right:8px;margin-bottom:8px}
        input[type="text"]:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(90,141,238,.25);outline:none}
        label{font-weight:500;margin-right:6px;font-size:.9em;color:var(--subtle-text-color)}
        #searchInput{max-width:350px;width:100%}
        .search-input-wrapper{margin-bottom:10px}
        #customBookArea{display:flex;align-items:center;flex-wrap:wrap;margin-top:10px;padding:12px;background-color:#fdfdfd;border:1px dashed var(--border-color);border-radius:6px}
        #customTitle{width:220px} #customAuthor{width:180px} #addCustomBtn{margin-left:5px}
        button{padding:8px 16px;font-size:.85em;font-weight:500;color:#fff;background-color:var(--primary-color);border:none;border-radius:5px;cursor:pointer;transition:background-color .2s ease,transform .1s ease;text-align:center;line-height:1.4} /* Added line-height */
        button:hover{background-color:#4a7ee2} button:active{transform:scale(.98)}
        button:disabled{background-color:#a8c5f5;cursor:not-allowed}
        .btn-remove{background-color:#dc3545} .btn-remove:hover{background-color:#c82333}
        #startPollBtn{background-color:var(--secondary-color)} #startPollBtn:hover{background-color:#e08e3a} #startPollBtn:disabled{background-color:#f9d3af;cursor:not-allowed}
        #addCustomBtn{background-color:#28a745} #addCustomBtn:hover{background-color:#218838}
        /* Search Results */
        .book-item{display:flex;align-items:center;border:1px solid transparent;padding:6px 8px;margin-bottom:6px;background-color:#fff;border-radius:5px;transition:background-color .2s ease,border-color .2s ease}
        .book-item:hover{background-color:#f1f3f5}
        .book-item.selected{background-color:#eaf3fc;border-left:3px solid var(--primary-color);padding-left:5px}
        .book-item img,.book-item .placeholder-svg{width:35px;height:52px;object-fit:cover;margin-right:10px;border-radius:3px;background-color:var(--border-color);flex-shrink:0}
        .book-info{flex-grow:1;overflow:hidden}
        .book-info p{margin:0;font-size:.75em;color:var(--subtle-text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .book-info strong{font-size:.9em;color:var(--text-color);font-weight:500;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .book-item button{margin-left:10px;padding:5px 10px;font-size:.8em}
        /* Selected Cards */
        #selectedBooksList{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px;margin-top:15px}
        .selected-card{background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:6px;box-shadow:var(--card-shadow);text-align:center;display:flex;flex-direction:column;box-sizing:border-box;overflow:hidden;position:relative;padding:12px}
        .selected-card img,.selected-card .placeholder-svg{width:65px;height:97px;object-fit:cover;border-radius:4px;background-color:var(--border-color);margin:0 auto 8px auto}
        .selected-card h3{font-size:.9em;margin:4px 0 2px 0;font-weight:600;line-height:1.3}
        .selected-card p{font-size:.75em;color:var(--subtle-text-color);margin:2px 0}
        .selected-card .links{margin-top:6px;font-size:.7em;line-height:1.4;margin-bottom:8px}
        .selected-card .links a{color:var(--primary-color);text-decoration:none;margin:0 3px} .selected-card .links a:hover{text-decoration:underline}
        .selected-card .btn-remove{margin-top:auto;font-size:.75em;padding:5px 10px} /* Use auto margin to push down */
        /* Poll View */
        #pollView{margin-top:20px;text-align:center}
        #pollTitle{font-size:1.5em;margin-bottom:20px;font-weight:600}
        .poll-options{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-top:15px;text-align:left}
        .poll-option-card{background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;padding:15px;box-shadow:var(--card-shadow);display:flex;flex-direction:column;justify-content:space-between}
        .poll-option-card h4{margin:0 0 5px 0;font-size:1.05em;font-weight:600}
        .poll-option-card p{margin:3px 0;font-size:.85em;color:var(--subtle-text-color)}
        .poll-option-card .links{margin:10px 0;font-size:.75em} .poll-option-card .links a{margin:0 3px}
        .vote-area{margin-top:15px;display:flex;align-items:center;justify-content:space-between}
        .vote-count{font-size:1.1em;font-weight:600;color:var(--primary-color)}
        .btn-vote{background-color:#28a745} .btn-vote:hover{background-color:#218838}
        .btn-vote:disabled{background-color:#8ddba1;cursor:not-allowed}
        /* Status Messages */
        .status-message{text-align:center;padding:8px 0;color:var(--subtle-text-color);font-size:.85em}
        .loading{font-weight:500;color:var(--primary-color)} .error{color:#dc3545;font-weight:500}
        .placeholder-text{color:#999;text-align:center;padding:20px 0;font-style:italic;font-size:.85em}
        #pollShareArea{margin-top:20px;padding:15px;background-color:#e9f5e9;border:1px solid #badbcc;border-radius:6px;text-align:center}
        #pollShareLink{font-weight:600;word-break:break-all;display:inline-block;margin-top:5px;background:#fff;padding:5px 10px;border:1px solid #ccc;border-radius:4px;}
        #copyStatus { font-size: 0.8em; min-height: 1.2em; margin-top: 5px;} /* Style for copy status */
        #adminArea{display:block} /* Show by default, hide if pollId exists */
        #pollView{display:none} /* Hide by default, show if pollId exists */
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<div class="container">

    <!-- Section 1: Poll Creation Interface (Admin View) -->
    <div id="adminArea">
        <h1>Book Poll Creator</h1>
        <section class="add-books-area">
            <h2>1. Find or Add Books</h2>
            <div class="search-input-wrapper"> <label for="searchInput">Search Open Library:</label> <input type="text" id="searchInput" placeholder="Live search..." aria-label="Search Open Library"> </div>
            <div id="searchStatus" class="status-message"></div>
            <div id="searchResults" style="max-height: 250px; overflow-y: auto; padding-right: 5px; margin-bottom: 15px;"></div>
            <div id="customBookArea"> <label for="customTitle">Add Manually:</label> <input type="text" id="customTitle" placeholder="Book Title (Required)" aria-label="Custom Book Title"> <label for="customAuthor">by</label> <input type="text" id="customAuthor" placeholder="Author (Optional)" aria-label="Custom Book Author"> <button id="addCustomBtn" onclick="addCustomBook()">Add</button> </div>
            <div id="customAddStatus" class="status-message error" style="text-align: left; padding-left: 15px;"></div>
        </section>
        <section class="selected-area">
            <h2>2. Selected Books</h2>
            <div id="selectedBooksList"> <p class="placeholder-text">No books selected.</p> </div>
            <div style="text-align: center; margin-top: 25px;"> <button id="startPollBtn" onclick="startPoll()">Start Poll & Get Share Link</button> </div>
            <div id="pollShareArea" style="display: none;"> Poll Created! Share this link with your club: <br><a id="pollShareLink" href="#" target="_blank" rel="noopener noreferrer"></a> <br><button onclick="copyPollLink()" style="margin-top:10px; background-color: var(--primary-color)">Copy Link</button> <div id="copyStatus" class="status-message"></div> </div>
            <div id="startPollStatus" class="status-message error"></div>
        </section>
    </div>

    <!-- Section 2: Live Poll Display (Voter View) -->
    <div id="pollView">
        <h1 id="pollTitle">Loading Poll...</h1>
        <div id="pollOptions" class="poll-options">
            <!-- Poll options will be loaded here by JavaScript -->
            <p class="placeholder-text">Waiting for poll data...</p>
        </div>
        <div id="pollVoteStatus" class="status-message" style="margin-top: 15px; font-weight: bold;"></div>
    </div>

</div>

<script>
    // ---vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv---
    // --- YOUR SPECIFIC FIREBASE CONFIGURATION IS BELOW ---
    // ---   Verify the databaseURL is correct!          ---
    // ---vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv---
    const firebaseConfig = {
      apiKey: "AIzaSyAPi4OmZieXOwy3fDhXPPt9ac_KCE0_hkw",
      authDomain: "book-klubben-236e1.firebaseapp.com",
      // !!! VERIFY THIS URL IN YOUR FIREBASE CONSOLE (Realtime Database section) !!!
      databaseURL: "https://book-klubben-236e1-default-rtdb.firebaseio.com",
      projectId: "book-klubben-236e1",
      storageBucket: "book-klubben-236e1.appspot.com", // Corrected name
      messagingSenderId: "245694652120",
      appId: "1:245694652120:web:f550759de576dea4c7c1ad"
    };
    // ---^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^---
    // --- END OF YOUR FIREBASE CONFIGURATION            ---
    // ---^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^---


    // --- Initialize Firebase ---
    // Note: Using older Firebase v8 syntax as per included SDK script tags
    try {
         if (!firebase.apps.length) { // Prevent re-initialization
             firebase.initializeApp(firebaseConfig);
         }
    } catch(e) {
         console.error("Firebase initialization error:", e);
         alert("Could not initialize Firebase. Check configuration and ensure databaseURL is correct.");
    }
    const database = firebase.database(); // Use v8 database namespace

    // --- DOM Elements ---
    const searchInput = document.getElementById('searchInput');
    const searchResultsDiv = document.getElementById('searchResults');
    const searchStatusDiv = document.getElementById('searchStatus');
    const customTitleInput = document.getElementById('customTitle');
    const customAuthorInput = document.getElementById('customAuthor');
    const customAddStatusDiv = document.getElementById('customAddStatus');
    const selectedBooksListDiv = document.getElementById('selectedBooksList');
    const startPollBtn = document.getElementById('startPollBtn');
    const startPollStatus = document.getElementById('startPollStatus');
    const pollShareArea = document.getElementById('pollShareArea');
    const pollShareLink = document.getElementById('pollShareLink');
    const copyStatusDiv = document.getElementById('copyStatus');
    const adminAreaDiv = document.getElementById('adminArea');
    const pollViewDiv = document.getElementById('pollView');
    const pollTitleH1 = document.getElementById('pollTitle');
    const pollOptionsDiv = document.getElementById('pollOptions');
    const pollVoteStatusDiv = document.getElementById('pollVoteStatus');

    // --- State ---
    let selectedBooks = [];
    let searchTimeoutId = null;
    let currentPollId = null;
    let currentPollData = null; // Store fetched poll data
    let pollDataListener = null; // To store the listener function

    // --- Placeholder SVGs ---
    const selectedListPlaceholderSvg = `<svg width="65" height="97" viewBox="0 0 65 97" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="65" height="97" rx="3" fill="#E0E0E0"/><path d="M22 78H43" stroke="#BDBDBD" stroke-width="1.4" stroke-linecap="round"/><path d="M22 70H43" stroke="#BDBDBD" stroke-width="1.4" stroke-linecap="round"/><path d="M32.5 62C36.6421 62 40 58.6421 40 54.5C40 50.3579 36.6421 47 32.5 47C28.3579 47 25 50.3579 25 54.5C25 56.5 25.7 58.2 26.8 59.5" stroke="#BDBDBD" stroke-width="1.8" stroke-linecap="round"/><path d="M32.5 62V65" stroke="#BDBDBD" stroke-width="1.8" stroke-linecap="round"/><circle cx="32.5" cy="69" r="1.2" fill="#BDBDBD"/></svg>`;
    const searchResultPlaceholderSvg = `<svg width="35" height="52" viewBox="0 0 35 52" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="35" height="52" rx="2" fill="#E0E0E0"/><path d="M12 42H23" stroke="#BDBDBD" stroke-width="1.2" stroke-linecap="round"/><path d="M12 37H23" stroke="#BDBDBD" stroke-width="1.2" stroke-linecap="round"/><path d="M17.5 32C20.5376 32 23 29.5376 23 26.5C23 23.4624 20.5376 21 17.5 21C14.4624 21 12 23.4624 12 26.5C12 27.8 12.4 29 13.1 29.9" stroke="#BDBDBD" stroke-width="1.2" stroke-linecap="round"/><path d="M17.5 32V34.5" stroke="#BDBDBD" stroke-width="1.2" stroke-linecap="round"/><circle cx="17.5" cy="37" r="0.8" fill="#BDBDBD"/></svg>`;

    // --- Utility ---
    function debounce(func, delay) { return function(...args) { clearTimeout(searchTimeoutId); searchTimeoutId = setTimeout(() => func.apply(this, args), delay); }; }
    function getPollIdFromUrl() { const params = new URLSearchParams(window.location.search); return params.get('pollId'); }

    // --- Search ---
    async function performSearch() {
        const query = searchInput.value.trim();
        searchResultsDiv.innerHTML = '';
        if (!query) { searchStatusDiv.innerHTML = ''; return; }
        searchStatusDiv.innerHTML = '<p class="loading">Searching...</p>';
        const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=8&fields=key,title,author_name,cover_i,number_of_pages_median,isbn`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
            const data = await response.json();
            searchStatusDiv.innerHTML = '';
            displaySearchResults(data.docs);
        } catch (error) { console.error('Search Error:', error); searchStatusDiv.innerHTML = `<p class="error">Search failed.</p>`; searchResultsDiv.innerHTML = ''; }
    }
    const debouncedSearch = debounce(performSearch, 400);
    searchInput.addEventListener('input', debouncedSearch);

    function displaySearchResults(books) {
        if (!books || books.length === 0) { searchResultsDiv.innerHTML = '<p class="placeholder-text" style="padding: 8px 0;">No matches.</p>'; return; }
        books.forEach(book => {
            const title=book.title||'Unknown Title', authors=book.author_name?book.author_name.join(', '):'Unknown Author', coverId=book.cover_i, coverHtml=coverId?`<img src="https://covers.openlibrary.org/b/id/${coverId}-S.jpg" alt="" loading="lazy">`:searchResultPlaceholderSvg, pageCount=book.number_of_pages_median||'N/A', bookKey=book.key, isbn=book.isbn?book.isbn[0]:null, isSelected=selectedBooks.some(b=>b.key===bookKey);
            const bookElement=document.createElement('div'); bookElement.className=`book-item${isSelected?' selected':''}`; bookElement.dataset.key=bookKey;
            bookElement.innerHTML=`${coverHtml}<div class="book-info"><strong>${title}</strong><p>${authors}</p></div><button onclick="selectBook(this, '${bookKey}', '${title}', '${authors}', '${coverId || ''}', '${pageCount}', '${isbn || ''}')" ${isSelected?'disabled':''}>${isSelected?'Selected':'Select'}</button>`;
            searchResultsDiv.appendChild(bookElement);
        });
    }

    // --- Custom Book ---
    function addCustomBook() {
        const title = customTitleInput.value.trim(), author = customAuthorInput.value.trim()||'Unknown Author';
        customAddStatusDiv.textContent=''; if (!title) { customAddStatusDiv.textContent = 'Title required.'; customTitleInput.focus(); return; }
        const alreadyExists = selectedBooks.some(b=>b.title.toLowerCase() === title.toLowerCase() && b.authors.toLowerCase() === author.toLowerCase());
        if (alreadyExists) { customAddStatusDiv.textContent = 'Already selected.'; return; }
        const customKey = 'custom_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7);
        const bookData = { key: customKey, title, authors: author, coverId: null, pageCount: 'N/A', isbn: null, isCustom: true, link: '' };
        selectedBooks.push(bookData); displaySelectedBooksAdmin(); customTitleInput.value = ''; customAuthorInput.value = '';
    }

    // --- Selection (Admin View) ---
    function selectBook(buttonElement, key, title, authors, coverId, pageCount, isbn) {
        if (selectedBooks.some(b => b.key === key)) return;
        const link = key.startsWith('/works/') ? `https://openlibrary.org${key}` : ''; // Only generate link for works
        const bookData = { key, title, authors, coverId, pageCount, isbn, isCustom: false, link };
        selectedBooks.push(bookData); displaySelectedBooksAdmin();
        buttonElement.textContent = 'Selected'; buttonElement.disabled = true; buttonElement.closest('.book-item').classList.add('selected');
    }

    function removeBook(keyToRemove) {
        selectedBooks = selectedBooks.filter(book => book.key !== keyToRemove);
        displaySelectedBooksAdmin();
        const bookItemInSearch = searchResultsDiv.querySelector(`.book-item[data-key="${keyToRemove}"]`);
        if(bookItemInSearch){ const btn=bookItemInSearch.querySelector('button'); if(btn){ btn.textContent='Select'; btn.disabled=false; } bookItemInSearch.classList.remove('selected'); }
    }

    function generateLinksHtmlAdmin(book) {
        if (book.isCustom || !book.link) return `<div class="links" style="font-size:0.9em;color:#999;">(Custom)</div>`;
        const goodreadsSearchLink = `https://www.goodreads.com/search?q=${encodeURIComponent(book.isbn || `${book.title} ${book.authors}`)}`;
        return `<div class="links"><a href="${book.link}" target="_blank">OL</a> | <a href="${goodreadsSearchLink}" target="_blank">GR</a></div>`;
    }

     function displaySelectedBooksAdmin() {
        selectedBooksListDiv.innerHTML = '';
        pollShareArea.style.display = 'none';
        copyStatusDiv.textContent = '';

        if (selectedBooks.length === 0) {
            selectedBooksListDiv.innerHTML = '<p class="placeholder-text">No books selected.</p>';
            startPollBtn.disabled = true;
            return;
        }
        startPollBtn.disabled = false;
        selectedBooks.forEach(book => {
            const coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-S.jpg" alt="${book.title}" loading="lazy">` : selectedListPlaceholderSvg;
            const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount} pgs` : 'N/A pgs';
            const linksHtml = generateLinksHtmlAdmin(book);
            const cardElement = document.createElement('div');
            cardElement.classList.add('selected-card');
            cardElement.innerHTML = `
                ${coverHtml}
                <h3>${book.title}</h3>
                <p><em>${book.authors}</em></p>
                <p>${pageCountDisplay}</p>
                ${linksHtml}
                <button class="btn-remove" onclick="removeBook('${book.key}')">Remove</button>
            `;
            selectedBooksListDiv.appendChild(cardElement);
        });
    }

    // --- Poll Creation (Firebase) ---
    async function startPoll() {
        if (selectedBooks.length === 0) { startPollStatus.textContent = "Please select at least one book."; return; }
        startPollStatus.textContent = ""; startPollBtn.disabled = true; startPollBtn.textContent = "Starting...";

        const pollOptions = {};
        selectedBooks.forEach((book) => {
            const safeKey = book.key.replace(/[.$#[\]/]/g, '_');
            pollOptions[safeKey] = {
                title: book.title, author: book.authors, pageCount: book.pageCount,
                link: book.link, // Already generated during selection
                coverId: book.coverId, isCustom: book.isCustom, votes: 0
            };
        });
        const pollData = {
            title: "Book Club Vote - " + new Date().toLocaleDateString(),
            options: pollOptions, createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        try {
            const newPollRef = database.ref('polls').push();
            await newPollRef.set(pollData);
            currentPollId = newPollRef.key;
            const baseUrl = window.location.href.split('?')[0].split('#')[0]; // More robust base URL
            const shareUrl = `${baseUrl}?pollId=${currentPollId}`;
            pollShareLink.textContent = shareUrl; pollShareLink.href = shareUrl;
            pollShareArea.style.display = 'block'; startPollBtn.textContent = "Poll Started!";
            copyStatusDiv.textContent = '';
        } catch (error) {
            console.error("Error starting poll:", error);
            startPollStatus.textContent = "Error starting poll. Check console/Firebase rules.";
            startPollBtn.disabled = false; startPollBtn.textContent = "Start Poll & Get Share Link";
        }
    }

     function copyPollLink() {
        const link = pollShareLink.textContent;
        navigator.clipboard.writeText(link).then(() => {
            copyStatusDiv.textContent = "Link copied!"; copyStatusDiv.style.color = 'green';
            setTimeout(() => { copyStatusDiv.textContent = ''; }, 3000);
        }).catch(err => {
            copyStatusDiv.textContent = "Copy failed."; copyStatusDiv.style.color = 'red';
            console.error('Failed to copy link: ', err);
        });
     }

    // --- Poll Loading & Display (Voter View) ---
    function loadPoll(pollId) {
        console.log("Loading poll:", pollId);
        adminAreaDiv.style.display = 'none'; pollViewDiv.style.display = 'block';

        const pollRef = database.ref(`polls/${pollId}`);

        // Detach any previous listener before attaching a new one
        if (pollDataListener) {
            pollRef.off('value', pollDataListener);
        }

        // Define the listener function
        pollDataListener = (snapshot) => {
            if (!snapshot.exists()) {
                pollTitleH1.textContent = "Poll Not Found";
                pollOptionsDiv.innerHTML = "<p class='error'>Poll ID invalid or deleted.</p>";
                return;
            }
            currentPollData = snapshot.val();
            currentPollId = pollId;
            pollTitleH1.textContent = currentPollData.title || "Book Club Poll";
            pollOptionsDiv.innerHTML = ''; // Clear before re-rendering

            if (!currentPollData.options || Object.keys(currentPollData.options).length === 0) {
                 pollOptionsDiv.innerHTML = "<p class='placeholder-text'>No options found.</p>"; return;
            }

            Object.entries(currentPollData.options).forEach(([key, book]) => {
                const cardElement = document.createElement('div'); cardElement.classList.add('poll-option-card');
                const coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-S.jpg" alt="${book.title}" loading="lazy" style="width:50px; height:75px; object-fit:cover; margin-bottom:10px; border-radius:3px;">` : `<div style="width:50px; height:75px; background:#eee; display:inline-block; border-radius:3px; margin-bottom:10px;"></div>`; // Inline placeholder
                const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount} pgs` : 'N/A pgs';
                const linksHtml = generateLinksHtmlVoter(book);
                cardElement.innerHTML = `<div>${coverHtml}<h4>${book.title}</h4><p><em>by ${book.author}</em></p><p>${pageCountDisplay}</p>${linksHtml}</div><div class="vote-area"><span class="vote-count" id="votes-${key}">${book.votes || 0} Votes</span><button class="btn-vote" id="btn-${key}" onclick="castVote('${key}')">Vote</button></div>`;
                pollOptionsDiv.appendChild(cardElement);
            });
            checkIfVoted(); // Check voting status after rendering
        };

        // Attach the listener
        pollRef.on('value', pollDataListener, (error) => {
            console.error("Error loading poll data:", error);
            pollTitleH1.textContent = "Error Loading Poll";
            pollOptionsDiv.innerHTML = "<p class='error'>Could not fetch poll data.</p>";
        });
    }


    function generateLinksHtmlVoter(book) {
        if (book.isCustom || !book.link) return `<div class="links"></div>`;
        const goodreadsSearchLink = `https://www.goodreads.com/search?q=${encodeURIComponent(book.isbn || `${book.title} ${book.author}`)}`;
        return `<div class="links"><a href="${book.link}" target="_blank" rel="noopener">Open Library</a> | <a href="${goodreadsSearchLink}" target="_blank" rel="noopener">Goodreads</a></div>`;
    }

    // --- Voting ---
    async function castVote(bookKey) {
        if (!currentPollId) return;
        const votedPollKey = `voted_${currentPollId}`; // Key for localStorage

        if (localStorage.getItem(votedPollKey)) {
            pollVoteStatusDiv.textContent = "You have already voted in this poll.";
            pollVoteStatusDiv.style.color = "orange";
            disableAllVoteButtons();
            setTimeout(() => { pollVoteStatusDiv.textContent = ''; }, 4000);
            return;
        }

        const voteButton = document.getElementById(`btn-${bookKey}`);
        disableAllVoteButtons(); // Disable all buttons optimistically
        pollVoteStatusDiv.textContent = "Registering vote...";
        pollVoteStatusDiv.style.color = "var(--primary-color)";

        const voteRef = database.ref(`polls/${currentPollId}/options/${bookKey}/votes`);

        try {
            const result = await voteRef.transaction(currentVotes => (currentVotes || 0) + 1);
            if (result.committed) {
                 pollVoteStatusDiv.textContent = "Vote registered!";
                 pollVoteStatusDiv.style.color = "green";
                 localStorage.setItem(votedPollKey, bookKey); // Mark as voted with the option chosen
                 // Buttons are already disabled
            } else {
                 pollVoteStatusDiv.textContent = "Vote failed (conflict)."; // Maybe someone else voted at exact same time
                 pollVoteStatusDiv.style.color = "orange";
                 checkIfVoted(); // Re-enable buttons if not marked as voted
            }
        } catch (error) {
            console.error("Error casting vote:", error);
            pollVoteStatusDiv.textContent = "Error registering vote.";
            pollVoteStatusDiv.style.color = "red";
            checkIfVoted(); // Re-enable buttons if not marked as voted
        }
        setTimeout(() => { pollVoteStatusDiv.textContent = ''; }, 4000);
    }

     function disableAllVoteButtons() {
         const buttons = pollOptionsDiv.querySelectorAll('.btn-vote');
         buttons.forEach(button => button.disabled = true);
     }

     function checkIfVoted() {
        const votedOptionKey = localStorage.getItem(`voted_${currentPollId}`);
         if (votedOptionKey) {
             // If user has voted, ensure all buttons are disabled
             disableAllVoteButtons();
             pollVoteStatusDiv.textContent = "You have voted in this poll."; // Optionally show status
             pollVoteStatusDiv.style.color = "var(--subtle-text-color)";
         } else {
             // If user hasn't voted, ensure buttons are enabled (unless disabled for other reasons)
             const buttons = pollOptionsDiv.querySelectorAll('.btn-vote');
             buttons.forEach(button => button.disabled = false);
              pollVoteStatusDiv.textContent = ""; // Clear any previous status
         }
     }

    // --- Initialization ---
    window.onload = () => {
        const pollId = getPollIdFromUrl();
        if (pollId) {
            loadPoll(pollId);
        } else {
            adminAreaDiv.style.display = 'block';
            pollViewDiv.style.display = 'none';
            displaySelectedBooksAdmin(); // Initial display for admin
        }
    };

</script>

</body>
</html>
