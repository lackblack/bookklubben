<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Club Poll App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f7f8fa; /* Slightly different bg */
            --card-bg: #ffffff;
            --primary-color: #4f46e5; /* Indigo */
            --secondary-color: #f59e0b; /* Amber */
            --text-color: #1f2937; /* Darker Gray */
            --subtle-text-color: #6b7280; /* Medium Gray */
            --border-color: #e5e7eb;
            --input-border-color: #d1d5db;
            --card-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07);
            --card-hover-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --placeholder-bg: #f3f4f6;
            --button-radius: 8px; /* Modern rounded */
            --input-radius: 8px;
        }

        body {
            font-family: 'Inter', sans-serif; line-height: 1.6; margin: 0;
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: flex-start;
            padding: 30px 15px; min-height: 100vh;
        }

        .container {
            max-width: 800px; /* More compact */
            width: 100%; background: var(--card-bg);
            padding: 25px 30px; border-radius: 10px; /* Soft radius */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06); margin: 20px 0;
        }

        h1, h2 { text-align: center; font-weight: 600; margin-bottom: 20px; }
        h1 { color: var(--primary-color); font-size: 1.9em; margin-bottom: 35px; }
        h2 { font-size: 1.25em; margin-top: 30px; margin-bottom: 20px; text-align: left;
             border-bottom: 1px solid var(--border-color); padding-bottom: 8px;
             color: var(--subtle-text-color); font-weight: 500; }

        section { margin-bottom: 30px; padding-bottom: 10px; }

        /* --- Search Input Area --- */
        .search-input-wrapper { position: relative; margin-bottom: 15px; max-width: 450px; /* Limit width */ }
        #searchInput {
            width: 100%; padding: 10px 35px 10px 15px; /* Slightly less padding */
            border: 1px solid var(--input-border-color); border-radius: var(--input-radius);
            font-size: 0.9em; box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #fff; /* Ensure bg */
        }
        #searchInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15); outline: none;
        }
        #clearSearchBtn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: none; border: none; font-size: 1.3em; color: #9ca3af;
            cursor: pointer; padding: 0 5px; line-height: 1; display: none;
        }
        #clearSearchBtn:hover { color: var(--text-color); }

        /* --- Search Results --- */
        #searchResults { max-height: 250px; overflow-y: auto; padding-right: 5px; margin-bottom: 15px; }
        .book-item {
            display: flex; align-items: center; border-bottom: 1px solid #f3f4f6; /* Lighter border */
            padding: 8px 5px; /* Tighter padding */ margin-bottom: 0px;
            transition: background-color 0.2s ease;
        }
        .book-item:last-child { border-bottom: none; }
        .book-item:hover { background-color: #f9fafb; }
        .book-item img, .book-item .placeholder-svg {
            width: 32px; height: 48px; object-fit: cover; margin-right: 10px;
            border-radius: 3px; background-color: var(--placeholder-bg); flex-shrink: 0;
        }
        .book-info { flex-grow: 1; overflow: hidden; padding-right: 8px; }
        .book-info strong { font-size: 0.9em; color: var(--text-color); font-weight: 500; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-info p { margin: 0; font-size: 0.75em; color: var(--subtle-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-item button { margin-left: auto; padding: 5px 10px; font-size: 0.75em; flex-shrink: 0; } /* Smaller button */
        .book-item button:disabled { background-color: #e5e7eb; border-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }

        /* --- Custom Add Area --- */
        #customBookArea { display: flex; align-items: center; flex-wrap: wrap; margin-top: 15px; padding: 12px 15px; background-color: #f9fafb; border: 1px dashed var(--border-color); border-radius: var(--input-radius); }
        #customBookArea label { margin-right: 5px; font-size: 0.85em; color: var(--subtle-text-color); }
        #customBookArea input[type="text"] { margin-right: 10px; margin-bottom: 5px; font-size: 0.85em;}
        #customTitle { width: 200px; } #customAuthor { width: 160px; }

        /* --- Buttons General Modern --- */
        button {
            padding: 8px 16px; font-size: 0.85em; font-weight: 500; color: white;
            background-color: var(--primary-color); border: none; border-radius: var(--button-radius);
            cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            text-align: center; line-height: 1.4; display: inline-block; /* Ensure display for transforms */
             box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* Subtle shadow */
        }
        button:hover {
            filter: brightness(1.1); /* Slightly brighter */
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.06); /* Hover shadow */
        }
        button:active { transform: scale(0.97); filter: brightness(1); }
        button:disabled { background-color: #a5b4fc; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; filter: none; }
        .btn-remove{background-color:#ef4444} .btn-remove:hover{filter: brightness(1.1);} .btn-remove:active{transform: scale(.97); filter: brightness(1);}
        #startPollBtn{background-color:var(--secondary-color)} #startPollBtn:hover{filter: brightness(1.1);} #startPollBtn:active{transform: scale(.97); filter: brightness(1);} #startPollBtn:disabled{background-color:#fcd34d; cursor: not-allowed; opacity: 0.8;}
        #addCustomBtn{background-color:#22c55e} #addCustomBtn:hover{filter: brightness(1.1);} #addCustomBtn:active{transform: scale(.97); filter: brightness(1);}
        #revealResultsBtn { background-color: #8b5cf6; } #revealResultsBtn:hover { filter: brightness(1.1); } #revealResultsBtn:active{transform: scale(.97); filter: brightness(1);}
        .btn-vote{background-color:#10b981} .btn-vote:hover{filter: brightness(1.1);} .btn-vote:active{transform: scale(.97); filter: brightness(1);} .btn-vote:disabled{background-color:#a7f3d0;cursor:not-allowed; opacity: 0.8;}

        /* --- Selected Books (Admin) --- */
        #selectedBooksList{display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:15px; margin-top:15px;}
        .selected-card{background-color:var(--card-bg); border:1px solid var(--border-color); border-radius:var(--button-radius); box-shadow:var(--card-shadow); text-align:center; display:flex; flex-direction:column; padding:12px; transition: all 0.2s ease;}
        .selected-card:hover { transform: translateY(-2px); box-shadow: var(--card-hover-shadow); }
        .selected-card img, .selected-card .placeholder-svg{width:60px; height:90px; object-fit:cover; border-radius:4px; background-color:var(--placeholder-bg); margin:0 auto 8px auto;}
        .selected-card h3{font-size:.9em; margin:3px 0 1px 0; font-weight:600; line-height:1.3;}
        .selected-card p{font-size:.75em; color:var(--subtle-text-color); margin:1px 0;}
        .selected-card .links{margin-top:6px; font-size:.7em; line-height:1.4; margin-bottom:8px;}
        .selected-card .links a{color:var(--primary-color);text-decoration:none; margin:0 3px;} .selected-card .links a:hover{text-decoration:underline;}
        .selected-card .btn-remove{margin-top:auto; font-size:.75em; padding:5px 10px;} /* Keep small */

        /* --- Poll View & 3D Cards --- */
        #pollView { margin-top: 20px; text-align: center; }
        #pollTitle { font-size: 1.5em; margin-bottom: 25px; font-weight: 600; color: var(--text-color); }
        .poll-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; perspective: 1200px; }
        .quiz-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 18px; /* Slightly less padding */
            box-shadow: var(--card-shadow); text-align: center; transition: transform 0.4s ease, box-shadow 0.4s ease;
            display: flex; flex-direction: column; justify-content: space-between;
            transform-style: preserve-3d; cursor: pointer; min-height: 350px; /* Reduced height */
        }
        .quiz-card:hover { transform: rotateY(6deg) rotateX(2deg) translateZ(12px); box-shadow: var(--card-hover-shadow); } /* Subtle 3D */
        .quiz-card .card-content-wrapper { flex-grow: 1; }
        .quiz-card img, .quiz-card .placeholder-svg { width: 85px; height: 127px; object-fit: cover; border-radius: 5px; background-color: var(--placeholder-bg); margin: 0 auto 12px auto; border: 1px solid #eee; } /* Slightly smaller */
        .quiz-card h4 { margin: 4px 0 2px 0; font-size: 1em; font-weight: 600; line-height: 1.3; }
        .quiz-card p { margin: 3px 0; font-size: 0.8em; color: var(--subtle-text-color); }
        .quiz-card .links { margin: 10px 0; font-size: 0.7em; line-height: 1.4; }
        .quiz-card .links a { margin: 0 4px; }
        .vote-area { margin-top: 12px; display: flex; align-items: center; justify-content: space-between; width: 100%; border-top: 1px solid var(--border-color); padding-top: 12px; }
        .vote-count { font-size: 1em; font-weight: 600; color: var(--primary-color); visibility: hidden; opacity: 0; transition: visibility 0s linear 0.3s, opacity 0.3s ease-in-out; }
        .vote-count.visible { visibility: visible; opacity: 1; transition-delay: 0s; }

        /* --- Status Messages & Share Area --- */
        .status-message{text-align:center; padding:6px 0; color:var(--subtle-text-color); font-size:.8em;} /* Smaller status text */
        .loading{font-weight:500; color:var(--primary-color);} .error{color:#ef4444; font-weight:500;}
        .placeholder-text{color:#9ca3af; text-align:center; padding:20px 0; font-style:italic; font-size:.85em;}
        #pollShareArea{margin-top:20px; padding:15px; background-color:#f0fdf4; border:1px solid #a7f3d0; border-radius:var(--button-radius); text-align:center;}
        #pollShareLink{font-weight:500; word-break:break-all; display:inline-block; margin:6px 0; background:#fff; padding:5px 10px; border:1px solid #d1d5db; border-radius:6px; font-size: 0.9em;}
        #copyStatus { font-size: 0.75em; min-height: 1.1em; margin-top: 5px; }
        #adminArea{display:block} #pollView{display:none}
        .center-text { text-align: center; } /* Helper class */

    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<div class="container">

    <!-- Section 1: Poll Creation Interface (Admin View) -->
    <div id="adminArea">
        <h1>Book Poll Creator</h1>
        <section class="add-books-area">
            <h2>1. Find or Add Books</h2>
            <div class="search-input-wrapper">
                <label for="searchInput" class="sr-only">Search Open Library:</label>
                <input type="text" id="searchInput" placeholder="Search title or author..." aria-label="Search Open Library">
                <button id="clearSearchBtn" onclick="clearSearch()" aria-label="Clear search">Ã—</button>
            </div>
            <div id="searchStatus" class="status-message"></div>
            <div id="searchResults"></div>
            <div id="customBookArea">
                 <label for="customTitle">Add Manually:</label>
                 <input type="text" id="customTitle" placeholder="Book Title" aria-label="Custom Book Title">
                 <label for="customAuthor">by</label>
                 <input type="text" id="customAuthor" placeholder="Author" aria-label="Custom Book Author">
                 <button id="addCustomBtn" onclick="addCustomBook()">Add</button>
            </div>
            <div id="customAddStatus" class="status-message error" style="text-align: left; padding-left: 15px;"></div>
        </section>
        <section class="selected-area">
            <h2>2. Selected Books</h2>
            <div id="selectedBooksList"> <p class="placeholder-text">No books selected.</p> </div>
            <div class="center-text" style="margin-top: 25px;"> <!-- Centered button -->
                <button id="startPollBtn" onclick="startPoll()">Start Poll & Get Share Link</button>
            </div>
            <div id="pollShareArea" style="display: none;"> Poll Created! Share this link: <br><a id="pollShareLink" href="#" target="_blank" rel="noopener noreferrer"></a> <br><button onclick="copyPollLink()" style="margin-top:10px;">Copy Link</button> <div id="copyStatus" class="status-message"></div> </div>
            <div id="startPollStatus" class="status-message error center-text"></div> <!-- Centered status -->
        </section>
    </div>

    <!-- Section 2: Live Poll Display (Voter View) -->
    <div id="pollView">
        <h1 id="pollTitle">Loading Poll...</h1>
        <div id="pollOptions" class="poll-options">
            <p class="placeholder-text">Waiting for poll data...</p>
        </div>
        <div id="pollVoteStatus" class="status-message center-text" style="margin-top: 15px; font-weight: bold;"></div>
        <div id="revealButtonContainer" class="center-text"> <!-- Centered button -->
             <button id="revealResultsBtn" onclick="revealResults()">Reveal Results</button>
        </div>
    </div>

</div>

<script>
    // --- Firebase Config (Your specific config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAPi4OmZieXOwy3fDhXPPt9ac_KCE0_hkw",
      authDomain: "book-klubben-236e1.firebaseapp.com",
      databaseURL: "https://book-klubben-236e1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "book-klubben-236e1",
      storageBucket: "book-klubben-236e1.appspot.com",
      messagingSenderId: "245694652120",
      appId: "1:245694652120:web:f550759de576dea4c7c1ad"
    };
    // --- End Firebase Config ---

    // Initialize Firebase
    try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } }
    catch(e) { console.error("Firebase init error:", e); alert("Could not initialize Firebase."); }
    const database = firebase.database();

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchResultsDiv = document.getElementById('searchResults');
    const searchStatusDiv = document.getElementById('searchStatus');
    const customTitleInput = document.getElementById('customTitle');
    const customAuthorInput = document.getElementById('customAuthor');
    const customAddStatusDiv = document.getElementById('customAddStatus');
    const selectedBooksListDiv = document.getElementById('selectedBooksList');
    const startPollBtn = document.getElementById('startPollBtn');
    const startPollStatus = document.getElementById('startPollStatus');
    const pollShareArea = document.getElementById('pollShareArea');
    const pollShareLink = document.getElementById('pollShareLink');
    const copyStatusDiv = document.getElementById('copyStatus');
    const adminAreaDiv = document.getElementById('adminArea');
    const pollViewDiv = document.getElementById('pollView');
    const pollTitleH1 = document.getElementById('pollTitle');
    const pollOptionsDiv = document.getElementById('pollOptions');
    const pollVoteStatusDiv = document.getElementById('pollVoteStatus');
    const revealButtonContainer = document.getElementById('revealButtonContainer');
    const revealResultsBtn = document.getElementById('revealResultsBtn');

    // State
    let selectedBooks = [];
    let searchTimeoutId = null;
    let currentPollId = null;
    let currentPollData = null;
    let pollDataListener = null;

    // Placeholders
    const placeholderSvg = `<svg width="60" height="90" viewBox="0 0 60 90" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="60" height="90" rx="4" fill="#F3F4F6"/><path d="M15 75H45V80H15z M15 65H45V70H15z" fill="#E5E7EB"/><path d="M30 58 C37 58 41 49 30 35 C19 49 23 58 30 58 Z" fill="#E5E7EB"/></svg>`;
    const searchResultPlaceholderSvg = `<svg width="32" height="48" viewBox="0 0 32 48" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="32" height="48" rx="2" fill="#F3F4F6"/><path d="M8 40 H24 V 43 H8 z M8 35 H24 V 38 H8 z" fill="#E5E7EB"/><path d="M16 30 C19.5 30 22 25 16 18 C10 25 12.5 30 16 30 Z" fill="#E5E7EB"/></svg>`;
    const pollCardPlaceholderSvg = `<svg width="85" height="127" viewBox="0 0 85 127" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="85" height="127" rx="5" fill="#F3F4F6"/><path d="M22 105 H63 V 111 H22 z M22 92 H63 V 98 H22 z" fill="#E5E7EB"/><path d="M42.5 80 C51.5 80 57 68 42.5 50 C28 68 33.5 80 42.5 80 Z" fill="#E5E7EB"/></svg>`;

    // Utility
    function debounce(func, delay) { return function(...args) { clearTimeout(searchTimeoutId); searchTimeoutId = setTimeout(() => func.apply(this, args), delay); }; }
    function getPollIdFromUrl() { const params = new URLSearchParams(window.location.search); return params.get('pollId'); }

    // Search & Input Handling
    async function performSearch() {
        const query = searchInput.value.trim();
        searchResultsDiv.innerHTML = '';
        clearSearchBtn.style.display = query ? 'block' : 'none';
        if (!query) { searchStatusDiv.innerHTML = ''; return; }
        searchStatusDiv.innerHTML = '<p class="loading">Searching...</p>';
        // Reverted: Removed 'type' field request
        const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=10&fields=key,title,author_name,cover_i,number_of_pages_median,isbn`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
            const data = await response.json();
            searchStatusDiv.innerHTML = '';
            displaySearchResults(data.docs);
        } catch (error) { console.error('Search Error:', error); searchStatusDiv.innerHTML = `<p class="error">Search failed.</p>`; searchResultsDiv.innerHTML = ''; }
    }
    const debouncedSearch = debounce(performSearch, 400);
    searchInput.addEventListener('input', debouncedSearch);

    function clearSearch() {
        searchInput.value = ''; searchResultsDiv.innerHTML = '';
        searchStatusDiv.innerHTML = ''; clearSearchBtn.style.display = 'none';
        searchInput.focus();
    }

    function displaySearchResults(books) {
        searchResultsDiv.innerHTML = '';
        if (!books || books.length === 0) { searchResultsDiv.innerHTML = '<p class="placeholder-text" style="padding: 8px 0;">No matches found.</p>'; return; }

        // Reverted Filtering - simpler check for key presence and format
        const validBooks = books.filter(book => book.key && (book.key.startsWith('/works/') || book.key.startsWith('/books/')));

        if (validBooks.length === 0) {
             searchResultsDiv.innerHTML = '<p class="placeholder-text" style="padding: 8px 0;">No usable book results found.</p>'; return;
        }

        validBooks.forEach(book => {
            const title = book.title || 'Unknown Title';
            const authors = book.author_name ? book.author_name.join(', ') : 'Unknown Author';
            const coverId = book.cover_i;
            const coverHtml = coverId ? `<img src="https://covers.openlibrary.org/b/id/${coverId}-S.jpg" alt="" loading="lazy">` : searchResultPlaceholderSvg;
            const pageCount = book.number_of_pages_median || 'N/A';
            const bookKey = book.key; // Key is guaranteed to be valid here
            const isbn = book.isbn ? book.isbn[0] : null;
            const isSelected = selectedBooks.some(b => b.key === bookKey);

            const bookElement = document.createElement('div');
            bookElement.className = `book-item${isSelected ? ' selected' : ''}`;
            bookElement.dataset.key = bookKey;
            bookElement.innerHTML = `
                ${coverHtml}
                <div class="book-info">
                    <strong>${title}</strong>
                    <p>${authors}</p>
                    <p>Pages: ${pageCount}</p>
                </div>
                <button onclick="selectBook(this, '${bookKey}', '${title}', '${authors}', '${coverId || ''}', '${pageCount}', '${isbn || ''}')" ${isSelected ? 'disabled' : ''}>
                    ${isSelected ? 'Selected' : 'Select'}
                </button>`; // Select button is always enabled now if key is valid
            searchResultsDiv.appendChild(bookElement);
        });
    }

    // Custom Book
    function addCustomBook() {
        const title = customTitleInput.value.trim(), author = customAuthorInput.value.trim()||'Unknown Author';
        customAddStatusDiv.textContent=''; if (!title) { customAddStatusDiv.textContent = 'Title required.'; customTitleInput.focus(); return; }
        const alreadyExists = selectedBooks.some(b=>b.title.toLowerCase() === title.toLowerCase() && b.authors.toLowerCase() === author.toLowerCase());
        if (alreadyExists) { customAddStatusDiv.textContent = 'Already selected.'; return; }
        const customKey = 'custom_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7);
        const bookData = { key: customKey, title, authors: author, coverId: null, pageCount: 'N/A', isbn: null, isCustom: true, link: '' };
        selectedBooks.push(bookData); displaySelectedBooksAdmin(); customTitleInput.value = ''; customAuthorInput.value = '';
    }

    // Selection & Admin Display
    function selectBook(buttonElement, key, title, authors, coverId, pageCount, isbn) {
        if (selectedBooks.some(b => b.key === key)) return;
        const link = (key.startsWith('/works/') || key.startsWith('/books/')) ? `https://openlibrary.org${key}` : '';
        const bookData = { key, title, authors, coverId, pageCount, isbn, isCustom: false, link };
        selectedBooks.push(bookData); displaySelectedBooksAdmin();
        buttonElement.textContent = 'Selected'; buttonElement.disabled = true;
        buttonElement.closest('.book-item')?.classList.add('selected'); // Use optional chaining
    }

    function removeBook(keyToRemove) {
        selectedBooks = selectedBooks.filter(book => book.key !== keyToRemove);
        displaySelectedBooksAdmin();
        const bookItemInSearch = searchResultsDiv.querySelector(`.book-item[data-key="${keyToRemove}"]`);
        if(bookItemInSearch){ const btn=bookItemInSearch.querySelector('button'); if(btn){ btn.textContent='Select'; btn.disabled=false; } bookItemInSearch.classList.remove('selected'); }
    }

    function generateLinksHtmlAdmin(book) { /* Keep as is */ }
    function displaySelectedBooksAdmin() { /* Keep as is, but use updated placeholder */
        selectedBooksListDiv.innerHTML = '';
        pollShareArea.style.display = 'none'; copyStatusDiv.textContent = '';
        if (selectedBooks.length === 0) { selectedBooksListDiv.innerHTML = '<p class="placeholder-text">No books selected.</p>'; startPollBtn.disabled = true; return; }
        startPollBtn.disabled = false;
        selectedBooks.forEach(book => {
            const coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-S.jpg" alt="${book.title}" loading="lazy">` : placeholderSvg; // Use general placeholder
            const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount} pgs` : 'N/A pgs';
            const linksHtml = generateLinksHtmlAdmin(book);
            const cardElement = document.createElement('div'); cardElement.classList.add('selected-card');
            cardElement.innerHTML = `${coverHtml}<h3>${book.title}</h3><p><em>${book.authors}</em></p><p>${pageCountDisplay}</p>${linksHtml}<button class="btn-remove" onclick="removeBook('${book.key}')">Remove</button>`;
            selectedBooksListDiv.appendChild(cardElement);
        });
     }

    // Poll Creation
    async function startPoll() { /* Keep as is */ }
    function copyPollLink() { /* Keep as is */ }

    // Poll Loading & Display
    function loadPoll(pollId) { /* Keep as is, but use updated placeholder */
        console.log("Loading poll:", pollId);
        adminAreaDiv.style.display = 'none'; pollViewDiv.style.display = 'block';
        revealButtonContainer.style.display = 'block'; revealResultsBtn.style.display = 'inline-block';
        const pollRef = database.ref(`polls/${pollId}`);
        if (pollDataListener) { pollRef.off('value', pollDataListener); }
        pollDataListener = (snapshot) => {
            if (!snapshot.exists()) { /* ... error handling ... */ return; }
            currentPollData = snapshot.val(); currentPollId = pollId;
            pollTitleH1.textContent = currentPollData.title || "Book Club Poll";
            pollOptionsDiv.innerHTML = '';
            if (!currentPollData.options || Object.keys(currentPollData.options).length === 0) { /* ... no options handling ... */ return; }
            Object.entries(currentPollData.options).forEach(([key, book]) => {
                const cardElement = document.createElement('div'); cardElement.classList.add('quiz-card');
                const coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-M.jpg" alt="${book.title}" loading="lazy">` : pollCardPlaceholderSvg; // Use poll placeholder
                const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount} pages` : 'Pages: N/A';
                const linksHtml = generateLinksHtmlVoter(book);
                cardElement.innerHTML = `<div class="card-content-wrapper">${coverHtml}<h4>${book.title}</h4><p><em>by ${book.author}</em></p><p>${pageCountDisplay}</p>${linksHtml}</div><div class="vote-area"><span class="vote-count" id="votes-${key}">${book.votes || 0} Votes</span><button class="btn-vote" id="btn-${key}" onclick="castVote('${key}')">Vote</button></div>`;
                pollOptionsDiv.appendChild(cardElement);
            });
            checkIfVoted();
            if (localStorage.getItem(`results_revealed_${currentPollId}`)) { revealResults(true); }
        };
        pollRef.on('value', pollDataListener, (error) => { /* ... error handling ... */ });
    }

    function generateLinksHtmlVoter(book) { /* Keep as is */ }

    // Voting
    async function castVote(bookKey) { /* Keep as is */ }
    function disableAllVoteButtons() { /* Keep as is */ }
    function enableAllVoteButtons() { /* Keep as is */ }
    function checkIfVoted() { /* Keep as is */ }

    // Reveal Results
    function revealResults(isPageLoad = false) { /* Keep as is */
        pollOptionsDiv.querySelectorAll('.vote-count').forEach(span => span.classList.add('visible'));
        if (!isPageLoad && revealResultsBtn) { revealResultsBtn.style.display = 'none'; localStorage.setItem(`results_revealed_${currentPollId}`, 'true'); }
        else if (revealResultsBtn) { revealResultsBtn.style.display = 'none'; }
    }

    // Initialization
    window.onload = () => {
        const pollId = getPollIdFromUrl();
        if (pollId) { loadPoll(pollId); }
        else { adminAreaDiv.style.display = 'block'; pollViewDiv.style.display = 'none'; displaySelectedBooksAdmin(); }
    };
</script>

</body>
</html>
