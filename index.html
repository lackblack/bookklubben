<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Klubben poll_helper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=VT323&display=swap" rel="stylesheet">
    <style>
        
        :root {
            --bg-color: #d8d4c8;
            --card-bg: #ece8dc;
            --primary-color: #3a5d9f;
            --primary-hover-color: #4a72c4;
            --secondary-color: #c88e37;
            --secondary-hover-color: #d49f4e;
            --success-color: #5a8a5a;
            --success-hover-color: #6cac6c;
            --danger-color: #a94a4a;
            --danger-hover-color: #c85a5a;
            --text-color: #333330;
            --subtle-text-color: #6b6a64;
            --border-color: #a09c91;
            --border-highlight: #f8f6f1;
            --border-shadow: #8a867d;
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--primary-color);
            --input-bg: #f9f7f2;
            --card-shadow: 2px 2px 0px 0px var(--border-shadow);
            --card-shadow-hover: 4px 4px 0px 0px var(--border-shadow);
            --font-retro: 'VT323', monospace;
            --font-sans: 'Inter', sans-serif;
            --radius: 0px;
        }

        /* Base & Layout */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--font-retro); line-height: 1.6; font-size: 17px;
            margin: 0; background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; align-items: center;
            padding: 20px 15px; min-height: 100vh;
        }
        .container {
            max-width: 800px; width: 100%; background: var(--card-bg);
            padding: 20px 30px; border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow); margin: 15px 0;
            border-style: outset; border-width: 2px;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
        }
        h1 {
            text-align: center; margin-bottom: 25px; font-weight: normal;
            text-transform: uppercase; letter-spacing: 1px; color: var(--primary-color);
            text-shadow: 1px 1px 0px var(--border-highlight); font-size: 2.4em;
        }
        h2 { /* Step Headers */
            font-size: 1.0em; margin: 0 0 35px 0; color: var(--subtle-text-color);
            text-transform: uppercase; font-weight: normal; text-align: center;
            border: none; padding-bottom: 0; display: block;
        }
        section { margin-bottom: 30px; padding-bottom: 5px; }
        .section-content { margin-top: -1.5em; }

        /* Forms & Buttons */
        input[type="text"], input[type="url"], textarea {
            padding: 8px 10px; border: 1px solid;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
            border-style: inset; border-width: 2px; font-size: 1em;
            box-sizing: border-box; transition: border-color .2s ease, box-shadow .2s ease;
            background-color: var(--input-bg); margin-bottom: 8px; width: 100%;
            font-family: var(--font-retro); color: var(--text-color); outline: none;
        }
        input[type="text"]:focus, input[type="url"]:focus, textarea:focus { background-color: #fff; }
        textarea { resize: vertical; min-height: 60px; }
         #copyInfoTextarea { /* Style for hidden textarea */
              position: absolute; left: -9999px; top: auto;
              width: 1px; height: 1px; overflow: hidden; opacity: 0;
         }

        label {
            font-weight: normal; margin-right: 5px; margin-top: 20px; font-size: 1em;
            color: var(--subtle-text-color); display: inline-block; margin-bottom: 3px;
            text-transform: uppercase;
        }

        /* Search Area */
        .search-input-wrapper { margin-bottom: 15px; text-align: center; }
        #searchInput {
             max-width: 550px; text-align: center; font-size: 1.1em;
             padding: 10px 12px; display: block; margin: 5px auto 0 auto;
        }

        /* Manual Add Area */
        .manual-add-area {
            margin-top: 15px; padding: 8px 10px; border-top: 1px dashed var(--border-color);
            text-align: center;
        }
         #manualEntryForm {
             display: flex; flex-wrap: wrap; align-items: flex-end; gap: 8px;
             justify-content: center;
         }
         .manual-field-group {
            display: flex; flex-direction: column; align-items: flex-start;
         }
         .manual-field-group label {
             font-size: 0.9em; margin-bottom: 1px; color: var(--text-color);
         }
         #manualTitleInput { width: 180px; margin-bottom: 0; }
         #manualAuthorInput { width: 160px; margin-bottom: 0; }
         #manualLinkInput { width: 180px; margin-bottom: 0; }
         #addManualEntryBtn {
             margin-bottom: 0; align-self: flex-end; height: 38px; padding-top: 5px;
             margin-left: 5px;
         }

        /* Buttons General */
        button {
            padding: 6px 15px; font-size: 1em; font-weight: normal; color: var(--text-color);
            background-color: var(--card-bg); border: 1px solid;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; cursor: pointer;
            transition: background-color .1s ease, transform .1s ease, border-style .1s ease;
            text-align: center; line-height: 1.3; box-shadow: none;
            text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; outline: none;
        }
        button:hover { background-color: #fff; }
        button:active { border-style: inset; background-color: #f5f2ea; transform: translate(1px, 1px); }
        button:disabled {
            border-color: var(--border-color); border-style: solid; border-width: 1px;
            cursor: not-allowed; color: var(--subtle-text-color); background-color: #e5e1d8; transform: none;
        }
        /* Specific Button Colors */
        #addManualEntryBtn, .btn-vote, #startPollBtn, #revealVotesBtn { background-color: #d4e2d4; }
        #addManualEntryBtn:hover, .btn-vote:hover, #startPollBtn:hover, #revealVotesBtn:hover { background-color: #e0f0e0; }
        #addManualEntryBtn:active, .btn-vote:active, #startPollBtn:active, #revealVotesBtn:active { background-color: #c8d8c8; }

        /* Card Buttons */
        .btn-remove { background-color: #eacccc; }
        .btn-remove:hover { background-color: #f5dddd; }
        .btn-remove:active { background-color: #e0c0c0; }

        .btn-copy-single { background-color: var(--secondary-color); } /* Copy Button on Card */
        .btn-copy-single:hover { background-color: var(--secondary-hover-color); }
        .btn-copy-single:active { background-color: #b88030; }


        #closeSearchBtn {
             position: absolute; top: -10px; right: -1px; z-index: 10;
             padding: 1px 7px; font-size: 1.3em; line-height: 1.1; display: none;
         }

        /* Search Results */
        .search-results-container { position: relative; max-width: 580px; margin: 10px auto 15px auto; }
        #searchResults {
            max-height: 220px; overflow-y: auto; padding: 5px; border: 1px solid var(--border-color);
            background: var(--input-bg); min-height: 0; border-style: inset; border-width: 2px;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
        }
         #searchResults:empty { border: none; padding: 0; }
         #searchResults:not(:empty) + #closeSearchBtn { display: block; }
        .book-item {
            display: flex; align-items: center; border-bottom: 1px dotted var(--border-color);
            padding: 6px 8px; margin-bottom: 0; background-color: transparent; transition: background-color .2s ease;
        }
         .book-item:last-child { border-bottom: none; }
        .book-item:hover { background-color: rgba(0,0,0,0.03); }
        .book-item.selected { background-color: rgba(58, 93, 159, 0.1); font-weight: bold; }
         .book-item img, .book-item .placeholder-svg {
             width: 30px; height: 45px; object-fit: cover; margin-right: 10px;
             border: 1px solid var(--border-color); flex-shrink: 0;
             image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
         }
        .book-info { flex-grow: 1; overflow: hidden; }
        .book-info p { margin: 1px 0 0 0; font-size: 0.9em; color: var(--subtle-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-info strong { font-size: 0.95em; color: var(--text-color); font-weight: normal; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 1px; }
        .book-item button { margin-left: 8px; padding: 4px 10px; font-size: 0.9em; }


        /* Selected Cards */
        #selectedBooksList { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
        .selected-card {
            background-color: var(--card-bg); border: 1px solid;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; box-shadow: none; text-align: center;
            display: flex; flex-direction: column;
            overflow: hidden; padding: 15px;
            transition: transform 0.1s ease-out, border-color 0.1s ease-out;
        }
        .selected-card:hover { transform: translate(-1px, -1px); border-color: #fff #aaa #aaa #fff; }
        .selected-card img, .selected-card .placeholder-svg {
            width: 65px; height: 97px; object-fit: cover; border: 1px solid;
            border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
            border-style: inset; border-width: 2px; margin: 0 auto 10px auto;
            image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
            background-color: var(--border-color); flex-shrink: 0;
        }
         .selected-card .manual-placeholder-svg {
             border: 1px solid var(--border-color); border-style: solid; background-color: #e0dccf;
         }

        .selected-card h3 { font-size: 1.1em; margin: 4px 0 3px 0; font-weight: normal; line-height: 1.3; color: var(--text-color); text-transform: none; text-align: center; }
        .selected-card p { font-size: 1em; color: var(--subtle-text-color); margin: 2px 0; text-align: center; }
        .selected-card p em { font-style: normal; }
        .selected-card .links {
            margin-top: 8px; font-size: 0.9em; line-height: 1.4; margin-bottom: 10px;
            flex-grow: 1; min-height: calc(0.9em * 1.4); word-wrap: break-word; text-align: center;
        }
        .selected-card .links a { color: var(--primary-color); text-decoration: underline; margin: 0 5px; }
        .selected-card .links a:hover { color: var(--primary-hover-color); }

        /* ---vvv--- Card Buttons Area ---vvv--- */
        .selected-card .card-actions {
             margin-top: auto; /* Pushes buttons to the bottom */
             display: flex; /* Use flexbox */
             justify-content: center; /* Center buttons */
             gap: 10px; /* Space between buttons */
             flex-wrap: wrap; /* Allow wrapping */
             padding-top: 10px; /* Space above buttons */
             flex-shrink: 0;
        }
        .selected-card .card-actions button {
             font-size: 0.9em; padding: 5px 12px; width: auto; height: 30px; padding-top: 4px;
             margin: 0; /* Remove default margins if any */
        }
        /* ---^^^--- END Card Buttons Area ---^^^--- */


        /* Manual Card Specific */
         .selected-card.manual-entry { border-style: outset; }
         .selected-card.manual-entry .freeform-text { display: none; }


        /* Poll View */
        #pollView { margin-top: 25px; text-align: center; }
        #pollTitle { font-size: 1.8em; margin-bottom: 25px; }
        .poll-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; margin-top: 20px; text-align: left; }
        .poll-option-card {
            background-color: var(--card-bg); border: 1px solid;
            border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; box-shadow: none; padding: 18px;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.1s ease-out, border-color 0.1s ease-out, background-color 0.2s ease-out;
        }
        .poll-option-card:hover { transform: translate(-1px, -1px); border-color: #fff #aaa #aaa #fff; }
        .poll-card-content { text-align: center; margin-bottom: 12px; flex-grow: 1; }
        .poll-card-content img, .poll-card-content .placeholder-svg, .poll-card-content .manual-placeholder-svg {
             margin: 0 auto 10px auto; border: 1px solid;
             border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
             border-style: inset; border-width: 2px; width: 65px; height: 97px; object-fit: cover;
             image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
             background-color: var(--border-color);
        }
         .poll-card-content .manual-placeholder-svg {
              border: 1px solid var(--border-color); border-style: solid; background-color: #e0dccf;
          }

        .poll-option-card h4 { margin: 4px 0 4px 0; font-size: 1.15em; font-weight: normal; text-align: center; color: var(--text-color); text-transform: none; }
        .poll-option-card p { margin: 2px 0; font-size: 1em; color: var(--subtle-text-color); text-align: center; }
        .poll-option-card p em { font-style: normal; }
        .poll-option-card .links {
            margin: 10px 0; font-size: 0.9em; text-align: center;
            word-wrap: break-word; min-height: calc(0.9em * 1.4);
        }
        .poll-option-card .links a { color: var(--primary-color); text-decoration: underline; margin: 0 5px; }
        .poll-option-card .links a:hover { color: var(--primary-hover-color); }

        /* Poll vote area */
        .vote-area { margin-top: 12px; text-align: center; border-top: 1px dashed var(--border-color); padding-top: 12px; }
        .vote-count {
             display: block; font-size: 1.15em; color: var(--primary-color); margin-bottom: 10px;
             visibility: hidden; opacity: 0; height: 0;
             transition: opacity 0.3s ease-in-out, height 0.3s ease-in-out, visibility 0.3s;
         }
         #pollView.votes-revealed .vote-count {
             visibility: visible; opacity: 1; height: auto; margin-bottom: 10px;
         }
        .btn-vote { width: auto; font-size: 1em; padding: 7px 18px; height: 34px; padding-top: 6px;}

        /* Reveal Button Styling */
         #revealVotesArea { margin: 25px 0 10px 0; text-align: center; }
         #revealVotesBtn { font-size: 1.05em; padding: 8px 20px; height: 36px; padding-top: 7px; }

        /* Winner Highlighting */
         .poll-option-card.winner {
             border-color: var(--success-hover-color) var(--success-color) var(--success-color) var(--success-hover-color);
         }
         .poll-option-card.winner .vote-count {
             color: var(--success-color); font-weight: bold;
         }

        /* Status & Placeholders */
        .status-message { text-align: center; padding: 5px 0; color: var(--subtle-text-color); font-size: 0.95em; min-height: 1.4em; text-transform: uppercase; }
        .loading { color: var(--secondary-color); }
        .error { color: var(--danger-color); }
        .placeholder-text { color: var(--subtle-text-color); text-align: center; padding: 15px 0; font-size: 0.95em; line-height: 1.4; }

        /* Poll Share Area */
        #pollShareArea { /* For Firebase Poll Link */
            margin-top: 20px; padding: 15px; background-color: rgba(0,0,0,0.03);
            border: 1px solid; border-color: var(--border-highlight) var(--border-shadow) var(--border-shadow) var(--border-highlight);
            border-style: outset; border-width: 2px; text-align: center;
        }
         #pollShareLink {
             font-weight: normal; word-break: break-all; display: block; margin: 8px 0;
             background: var(--input-bg); padding: 8px; border: 1px solid;
             border-color: var(--border-shadow) var(--border-highlight) var(--border-highlight) var(--border-shadow);
             border-style: inset; border-width: 2px; color: var(--primary-color);
             text-decoration: none; font-size: 0.95em;
         }
         #pollShareLink:hover { background-color: #fff; }
         #pollShareArea button { font-size: 0.95em; padding: 6px 15px; height: 30px; padding-top: 5px; } /* Poll link copy btn */


         /* Admin Action Buttons Area */
         .admin-action-buttons {
             text-align: center; margin-top: 25px;
         }
         /* Status messages for buttons */
         #copyInfoStatus, /* Re-purposed for single copy feedback */
         #copyStatus, /* Poll Link Copy feedback */
         #startPollStatus {
             min-height: 1.3em; margin-top: 5px; font-size: 0.9em;
             text-align: center;
         }


        /* View Visibility */
        #adminArea { display: block; }
        #pollView { display: none; }

        /* Placeholders */
        .placeholder-svg { display: block; flex-shrink: 0; border: none !important; background-color: var(--border-color); }
        .placeholder-svg rect { fill: none; }
        .placeholder-svg path, .placeholder-svg circle { stroke: var(--subtle-text-color); fill: var(--subtle-text-color); }
        .manual-placeholder-svg text { font-family: var(--font-retro); fill: var(--text-color); }

    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<div class="container">

    <!-- Section 1: Poll Creation Interface (Admin View) -->
    <div id="adminArea">
        <h1>Book Klubben 🍷📚 poll_helper</h1>
        <section class="add-books-area">
            <h2></h2>
            <div class="section-content">
                <div class="search-input-wrapper">
                    <label for="searchInput"> Search Open_Library & add books </label>
                    <input type="text" id="searchInput" placeholder="Enter Title / Author..." aria-label="Search Open Library">
                </div>
                <div id="searchStatus" class="status-message"></div>

                <div class="search-results-container">
                    <div id="searchResults"></div>
                    <button id="closeSearchBtn" onclick="closeSearchResults()" title="Close Search Results">X</button>
                </div>

                <div class="manual-add-area">
                     <form id="manualEntryForm" onsubmit="addManualEntry(); return false;">
                         <div class="manual-field-group">
                             <label for="manualTitleInput">Title:</label>
                             <input type="text" id="manualTitleInput" placeholder="(Required)" aria-label="Manual Book Title">
                         </div>
                         <div class="manual-field-group">
                              <label for="manualAuthorInput">Author/Info:</label>
                             <input type="text" id="manualAuthorInput" placeholder="(Optional)" aria-label="Manual Book Author">
                         </div>
                         <div class="manual-field-group">
                            <label for="manualLinkInput">Link:</label>
                            <input type="url" id="manualLinkInput" placeholder="(Optional URL)" aria-label="Manual Book Link">
                         </div>
                         <button type="submit" id="addManualEntryBtn">Add Manual</button>
                     </form>
                     <div id="manualAddStatus" class="status-message error"></div>
                 </div>
            </div>
        </section>

        <section class="selected-area">
             <h2>Selected books</h2>
             <div class="section-content">
                <div id="selectedBooksList">
                     <p class="placeholder-text"></p>
                 </div>

                 <!-- Hidden Textarea for Copy Info -->
                 <textarea id="copyInfoTextarea" aria-hidden="true"></textarea>
                 <!-- Status message for single copy actions -->
                 <div id="copyInfoStatus" class="status-message"></div>

                 <!-- Make Poll Button Area -->
                 <div class="admin-action-buttons">
                    <button id="startPollBtn" onclick="startPoll()">MAKE_POLL</button>
                 </div>
                 <div id="startPollStatus" class="status-message error"></div>


                 <!-- Poll Link Share Area (shown after poll creation) -->
                 <div id="pollShareArea" style="display: none;">
                     >> Poll Ready! Share Link:
                     <a id="pollShareLink" href="#" target="_blank" rel="noopener noreferrer"></a>
                     <button onclick="copyPollLink()" style="margin-top: 10px;">Copy_Link</button>
                     <div id="copyStatus" class="status-message"></div>
                 </div>

             </div>
         </section>
    </div>

    <!-- Section 2: Live Poll Display (Voter View) -->
    <div id="pollView">
        <h1 id="pollTitle">LOAD POLL...</h1>
        <div id="pollOptions" class="poll-options">
             <p class="placeholder-text">[[ Waiting For Data ]]</p>
        </div>
        <div id="revealVotesArea" style="display: none;">
            <button id="revealVotesBtn" onclick="revealVotes()">Reveal Votes</button>
        </div>
        <div id="pollVoteStatus" class="status-message" style="margin-top: 15px;"></div>
    </div>

</div>

<script>
   
    const firebaseConfig = {
      apiKey: "AIzaSyAPi4OmZieXOwy3fDhXPPt9ac_KCE0_hkw",
      authDomain: "book-klubben-236e1.firebaseapp.com",
      databaseURL: "https://book-klubben-236e1-default-rtdb.europe-west1.firebasedatabase.app", 
      projectId: "book-klubben-236e1",
      storageBucket: "book-klubben-236e1.appspot.com",
      messagingSenderId: "245694652120",
      appId: "1:245694652120:web:f550759de576dea4c7c1ad"
    };
  
    let database;
    try {
         if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
         database = firebase.database();
         console.log("Firebase Initialized Successfully.");
    } catch(e) {
        console.error("FIREBASE INIT ERROR:", e);
        document.body.innerHTML = `<div style="padding: 20px; background-color: #fdd; border: 2px solid red; color: black; font-family: monospace;"><h1>FATAL ERROR</h1><p>Could not initialize Firebase. Check the <code>firebaseConfig</code> object.</p><p><strong>Error Details:</strong> ${e.message}</p><p>See console (F12) for more details.</p></div>`;
        throw new Error("Firebase initialization failed.");
    }

    // --- DOM Elements ---
    const searchInput = document.getElementById('searchInput');
    const searchResultsDiv = document.getElementById('searchResults');
    const searchStatusDiv = document.getElementById('searchStatus');
    const manualTitleInput = document.getElementById('manualTitleInput');
    const manualAuthorInput = document.getElementById('manualAuthorInput');
    const manualLinkInput = document.getElementById('manualLinkInput');
    const manualAddStatusDiv = document.getElementById('manualAddStatus');
    const selectedBooksListDiv = document.getElementById('selectedBooksList');
    const startPollBtn = document.getElementById('startPollBtn');
    const startPollStatus = document.getElementById('startPollStatus');
    const pollShareArea = document.getElementById('pollShareArea');
    const pollShareLink = document.getElementById('pollShareLink');
    const copyStatusDiv = document.getElementById('copyStatus'); // For poll link copy
    const adminAreaDiv = document.getElementById('adminArea');
    const pollViewDiv = document.getElementById('pollView');
    const pollTitleH1 = document.getElementById('pollTitle');
    const pollOptionsDiv = document.getElementById('pollOptions');
    const pollVoteStatusDiv = document.getElementById('pollVoteStatus');
    const closeSearchBtn = document.getElementById('closeSearchBtn');
    const revealVotesArea = document.getElementById('revealVotesArea');
    const revealVotesBtn = document.getElementById('revealVotesBtn');
    const copyInfoTextarea = document.getElementById('copyInfoTextarea'); // Reused hidden textarea
    const copyInfoStatus = document.getElementById('copyInfoStatus'); // Reused status div for single copies

    // --- State ---
    let selectedBooks = [];
    let searchTimeoutId = null;
    let currentPollId = null;
    let currentPollData = null;
    let pollDataListener = null;
    let votesRevealed = false;

    // --- Placeholders ---
    const searchResultPlaceholderSvg = `<svg width="30" height="45" viewBox="0 0 30 45" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="30" height="45"/><path d="M10 37H20" stroke="#6c6a64" stroke-width="1.2" /><path d="M10 33H20" stroke="#6c6a64" stroke-width="1.2" /><path d="M15 29C17.5 29 19.5 27 19.5 24.5C19.5 22 17.5 20 15 20C12.5 20 10.5 22 10.5 24.5C10.5 25.5 10.9 26.5 11.5 27.2" stroke="#6c6a64" stroke-width="1.2" /><path d="M15 29V31" stroke="#6c6a64" stroke-width="1.2" /><circle cx="15" cy="33" r="0.8" fill="#6c6a64"/></svg>`;
    const selectedListPlaceholderSvg = `<svg width="65" height="97" viewBox="0 0 65 97" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="65" height="97"/><path d="M22 80H43" stroke="#6c6a64" stroke-width="1.5" /><path d="M22 72H43" stroke="#6c6a64" stroke-width="1.5"/><path d="M32.5 65C36.9 65 40.5 61.4 40.5 57C40.5 52.6 36.9 49 32.5 49C28.1 49 24.5 52.6 24.5 57C24.5 58.9 25.2 60.6 26.3 61.8" stroke="#6c6a64" stroke-width="1.8" /><path d="M32.5 65V68" stroke="#6c6a64" stroke-width="1.8" /><circle cx="32.5" cy="72" r="1.5" fill="#6c6a64"/></svg>`;

    // --- Manual Entry Placeholder SVG Generator ---
    function generateManualPlaceholderSvg(title = "Manual Entry") {
        let displayText = title.replace(/</g, '').replace(/>/g, '');
        if (displayText.length > 15) displayText = displayText.substring(0, 14) + '…';
        let displayText2 = "";
         if (title.length > 15) {
            displayText2 = title.substring(15);
             if (displayText2.length > 15) displayText2 = displayText2.substring(0, 14) + '…';
         }
        return `<svg width="65" height="97" viewBox="0 0 65 97" fill="none" xmlns="http://www.w3.org/2000/svg" class="manual-placeholder-svg">
                    <rect x="1" y="1" width="63" height="95" fill="#e0dccf" stroke="#a09c91" stroke-width="1"/>
                    <rect x="8" y="10" width="49" height="18" fill="#f0ede6" />
                    <text x="12" y="23" font-size="12px" text-anchor="start">${escapeHtmlBasic(displayText)}</text>
                     ${displayText2 ? `<text x="12" y="38" font-size="12px" text-anchor="start">${escapeHtmlBasic(displayText2)}</text>` : ''}
                     <rect x="8" y="65" width="49" height="3" fill="#c88e37" />
                    <rect x="8" y="75" width="49" height="3" fill="#a09c91" />
                </svg>`;
    }

    // --- Utility ---
    function debounce(func, delay) { return function(...args) { clearTimeout(searchTimeoutId); searchTimeoutId = setTimeout(() => func.apply(this, args), delay); }; }
    function getPollIdFromUrl() { const params = new URLSearchParams(window.location.search); return params.get('pollId'); }
    function sanitizeKey(key) { return key.replace(/[.$#[\]/]/g, '_'); }
    function createUniqueKey(prefix = 'key_') { return prefix + Date.now() + '_' + Math.random().toString(36).substring(2, 9); }
    function escapeHtmlBasic(str) {
        if (typeof str !== 'string') str = String(str);
        return str.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'");
    }

    // --- Search & Close Results ---
    async function performSearch() {
        const query = searchInput.value.trim();
        searchResultsDiv.innerHTML = '';
        if (!query) { searchStatusDiv.textContent = ''; return; }
        searchStatusDiv.innerHTML = '<span class="loading">SEARCHING...</span>';
        const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=6&fields=key,title,author_name,cover_i,number_of_pages_median,isbn`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ERR: ${response.status}`);
            const data = await response.json();
            searchStatusDiv.textContent = '';
            displaySearchResults(data.docs);
        } catch (error) {
            console.error('Search Err:', error);
            searchStatusDiv.innerHTML = `<span class="error">SEARCH FAILED.</span>`;
            searchResultsDiv.innerHTML = '';
        }
    }
    const debouncedSearch = debounce(performSearch, 450);
    searchInput.addEventListener('input', debouncedSearch);

    function displaySearchResults(books) {
        searchResultsDiv.innerHTML = '';
        if (!books || books.length === 0) {
            searchResultsDiv.innerHTML = '<p class="placeholder-text">[[ No Matches ]]</p>';
            return;
        }
        books.forEach(book => {
            const title = book.title || '???';
            const authors = book.author_name ? book.author_name.join(', ') : '???';
            const coverId = book.cover_i;
            const coverHtml = coverId ? `<img src="https://covers.openlibrary.org/b/id/${coverId}-S.jpg" alt="" loading="lazy">` : searchResultPlaceholderSvg;
            const pageCount = book.number_of_pages_median || 'N/A';
            const bookKey = book.key;
            const isbn = book.isbn ? book.isbn[0] : null;
            const isSelected = selectedBooks.some(b => b.key === bookKey);

            const escapeForJsString = (str) => {
                if (typeof str !== 'string') str = String(str || '');
                return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
            };

            const escapedKey = escapeForJsString(bookKey);
            const escapedTitle = escapeForJsString(title);
            const escapedAuthors = escapeForJsString(authors);
            const escapedCoverId = escapeForJsString(coverId);
            const escapedPageCount = escapeForJsString(pageCount);
            const escapedIsbn = escapeForJsString(isbn);

            const displayTitle = escapeHtmlBasic(title);
            const displayAuthors = escapeHtmlBasic(authors);

            const bookElement = document.createElement('div');
            bookElement.className = `book-item${isSelected ? ' selected' : ''}`;
            bookElement.dataset.key = bookKey;

            const onclickAttr = `selectBook(this, '${escapedKey}', '${escapedTitle}', '${escapedAuthors}', '${escapedCoverId}', '${escapedPageCount}', '${escapedIsbn}')`;

            bookElement.innerHTML = `
                ${coverHtml}
                <div class="book-info">
                    <strong>${displayTitle}</strong>
                    <p>by ${displayAuthors}</p>
                </div>
                <button onclick="${onclickAttr}" ${isSelected ? 'disabled' : ''}>
                    ${isSelected ? '.Sel.' : '+ Add'}
                </button>`;

            searchResultsDiv.appendChild(bookElement);
        });
    }

    function closeSearchResults() {
        searchResultsDiv.innerHTML = '';
        searchStatusDiv.textContent = '';
    }

    // --- Manual Book Addition ---
    function addManualEntry() {
        const title = manualTitleInput.value.trim();
        const author = manualAuthorInput.value.trim() || "N/A";
        const link = manualLinkInput.value.trim();
        manualAddStatusDiv.textContent = '';

        if (!title) {
            manualAddStatusDiv.textContent = 'TITLE NEEDED.';
            manualTitleInput.focus();
            return;
        }
        if (link && !link.startsWith('http://') && !link.startsWith('https://')) {
            manualAddStatusDiv.textContent = 'INVALID URL (use http/https).';
            manualLinkInput.focus();
            return;
        }
        const alreadyExists = selectedBooks.some(b =>
            b.isManual && b.title.toLowerCase() === title.toLowerCase() && b.authors.toLowerCase() === author.toLowerCase()
        );
        if (alreadyExists) {
            manualAddStatusDiv.textContent = 'DUPLICATE.';
            return;
        }

        const manualKey = createUniqueKey('manual_');
        const bookData = {
            key: manualKey, title: title, authors: author,
            link: link || '', isCustom: true, isFreeform: false, isManual: true,
            coverId: null, pageCount: 'N/A', isbn: null, votes: 0
        };
        selectedBooks.push(bookData);
        displaySelectedBooksAdmin();
        manualTitleInput.value = ''; manualAuthorInput.value = ''; manualLinkInput.value = '';
        manualTitleInput.focus();
    }

    // --- Selection (Admin View) ---
    function selectBook(buttonElement, key, title, authors, coverId, pageCount, isbn) {
        if (selectedBooks.some(b => b.key === key)) return;

        const openLibraryLink = key.startsWith('/works/') ? `https://openlibrary.org${key}` : '';

        const bookData = {
            key: key, title: title, authors: authors,
            coverId: coverId || null, pageCount: pageCount, isbn: isbn || null,
            isCustom: false, isFreeform: false, isManual: false,
            link: openLibraryLink, votes: 0
         };
        selectedBooks.push(bookData);
        displaySelectedBooksAdmin();

        buttonElement.textContent = '.Sel.';
        buttonElement.disabled = true;
        const bookItem = buttonElement.closest('.book-item');
        if (bookItem) { bookItem.classList.add('selected'); }
    }

    function removeBook(keyToRemove) {
        selectedBooks = selectedBooks.filter(book => book.key !== keyToRemove);
        displaySelectedBooksAdmin();
        const bookItemInSearch = searchResultsDiv.querySelector(`.book-item[data-key="${keyToRemove}"]`);
        if(bookItemInSearch){
            const btn = bookItemInSearch.querySelector('button');
            if(btn){ btn.textContent = '+ Add'; btn.disabled = false; }
            bookItemInSearch.classList.remove('selected');
        }
    }

    function generateLinksHtmlAdmin(book) {
        if (book.isManual) { return `<div class="links"></div>`; }

        const openLibraryLink = book.link ? `<a href="${book.link}" target="_blank" rel="noopener">OL</a>` : '';
        const goodreadsQuery = book.isbn ? book.isbn : `${book.title} ${book.authors}`;
        const goodreadsSearchLink = `https://www.goodreads.com/search?q=${encodeURIComponent(goodreadsQuery)}`;
        const showGr = book.isbn || (book.title && book.title !== '???' && book.authors && book.authors !== '???');
        const grLink = showGr ? `<a href="${goodreadsSearchLink}" target="_blank" rel="noopener">GR</a>` : '';
        const separator = openLibraryLink && grLink ? ' | ' : '';

        return `<div class="links">${openLibraryLink}${separator}${grLink}</div>`;
    }

    // --- ---vvv--- UPDATED Display Selected Books ---vvv--- ---
    function displaySelectedBooksAdmin() {
        selectedBooksListDiv.innerHTML = '';
        pollShareArea.style.display = 'none';
        copyStatusDiv.textContent = ''; // Clear poll link copy status
        copyInfoStatus.textContent = ''; // Clear single book copy status

        const hasBooks = selectedBooks.length > 0;
        startPollBtn.disabled = !hasBooks;

        if (!hasBooks) {
            selectedBooksListDiv.innerHTML = '<p class="placeholder-text"></p>';
            return;
        }

        selectedBooks.forEach(book => {
            const cardElement = document.createElement('div');
            cardElement.classList.add('selected-card');
            let cardContent = '';
            let coverHtml = '';

            // Escape book key for use in onclick attribute
            const escapedKey = escapeHtmlBasic(book.key.replace(/'/g, "\\'"));

            if (book.isManual) { // Manual Entry
                cardElement.classList.add('manual-entry');
                coverHtml = generateManualPlaceholderSvg(book.title);
                const manualLinkHtml = book.link
                    ? `<div class="links"><a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">User Link</a></div>`
                    : '<div class="links"></div>';

                cardContent = `
                    ${coverHtml}
                    <h3>${escapeHtmlBasic(book.title)}</h3>
                    <p><em>${escapeHtmlBasic(book.authors)}</em></p>
                    <p>(Manual)</p>
                    ${manualLinkHtml}
                    <div class="card-actions">
                        <button class="btn-copy-single" onclick="copySingleBookInfo('${escapedKey}')">Copy</button>
                        <button class="btn-remove" onclick="removeBook('${escapedKey}')">Remove</button>
                    </div>
                `;
            } else { // Standard Entry
                 coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-M.jpg" alt="${escapeHtmlBasic(book.title)}" loading="lazy">` : selectedListPlaceholderSvg;
                const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount}p` : '';
                const linksHtml = generateLinksHtmlAdmin(book);
                 cardContent = `
                    ${coverHtml}
                    <h3>${escapeHtmlBasic(book.title)}</h3>
                    <p><em>${escapeHtmlBasic(book.authors)}</em></p>
                    ${pageCountDisplay ? `<p>${pageCountDisplay}</p>` : ''}
                    ${linksHtml}
                    <div class="card-actions">
                        <button class="btn-copy-single" onclick="copySingleBookInfo('${escapedKey}')">Copy</button>
                        <button class="btn-remove" onclick="removeBook('${escapedKey}')">Remove</button>
                    </div>
                `;
            }
            cardElement.innerHTML = cardContent;
            selectedBooksListDiv.appendChild(cardElement);
        });
    }
    // --- ---^^^--- END UPDATED Display Selected Books ---^^^--- ---

    // --- Poll Creation (Firebase) ---
    async function startPoll() {
        if (!database) { startPollStatus.textContent = "DB ERROR"; return; }
        if (selectedBooks.length === 0) { startPollStatus.textContent = "NEED BOOKS"; return; }
        startPollStatus.textContent = ""; startPollBtn.disabled = true; startPollBtn.textContent = "Working...";
        pollShareArea.style.display = 'none';

        const pollOptions = {};
        selectedBooks.forEach((book) => {
            const safeKey = sanitizeKey(book.key);
            pollOptions[safeKey] = {
                title: book.title, author: book.authors, pageCount: book.pageCount,
                link: book.link, isbn: book.isbn, coverId: book.coverId,
                isCustom: book.isCustom, isManual: book.isManual || false, votes: 0
            };
        });
        const dateStr = new Date().toISOString().split('T')[0];
        const pollTitle = `BOOK VOTE ${dateStr}`;
        const pollData = { title: pollTitle, options: pollOptions, createdAt: firebase.database.ServerValue.TIMESTAMP };
        try {
            const newPollRef = database.ref('polls').push();
            await newPollRef.set(pollData);
            currentPollId = newPollRef.key;
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const shareUrl = `${baseUrl}?pollId=${currentPollId}`;
            pollShareLink.textContent = shareUrl; pollShareLink.href = shareUrl;
            pollShareArea.style.display = 'block';
            startPollBtn.textContent = "Poll Ready!"; // Keep disabled
            copyStatusDiv.textContent = ''; startPollStatus.textContent = "";
        } catch (error) {
            console.error("Poll Start Err:", error);
            startPollStatus.textContent = "POLL ERR.";
            startPollBtn.disabled = false; startPollBtn.textContent = "MAKE_POLL";
        }
    }

    function copyPollLink() {
        const link = pollShareLink.textContent;
        navigator.clipboard.writeText(link).then(() => {
            copyStatusDiv.textContent = "POLL LINK COPIED!"; copyStatusDiv.style.color = 'var(--success-color)';
            setTimeout(() => { copyStatusDiv.textContent = ''; }, 2500);
        }).catch(err => {
            copyStatusDiv.textContent = "FAIL."; copyStatusDiv.style.color = 'var(--danger-color)';
            console.error('Copy Fail: ', err);
        });
     }

    // --- ---vvv--- NEW Copy Single Book Info ---vvv--- ---
    function copySingleBookInfo(bookKey) {
        const book = selectedBooks.find(b => b.key === bookKey);
        if (!book) {
            copyInfoStatus.textContent = "BOOK NOT FOUND?";
            copyInfoStatus.style.color = "var(--danger-color)";
            console.error("Could not find book with key:", bookKey);
            return;
        }

        const title = book.title || "Unknown Title";
        const author = book.authors || "Unknown Author";
        let bestLink = "";

        // Determine best link (same logic as before)
        if (book.isManual && book.link) {
            bestLink = book.link;
        } else if (book.isbn) {
            bestLink = `https://www.goodreads.com/search?q=${encodeURIComponent(book.isbn)}`;
        } else if (!book.isManual && book.link) {
            bestLink = book.link; // OpenLibrary link
        }

        let infoString = `${title} - ${author}\n`;
        if (bestLink) {
            infoString += `Link: ${bestLink}`;
        }

        copyInfoTextarea.value = infoString.trim(); // Put text in hidden textarea
        copyInfoTextarea.select();

        try {
             navigator.clipboard.writeText(copyInfoTextarea.value).then(() => {
                 copyInfoStatus.textContent = `"${title}" INFO COPIED!`; // Provide specific feedback
                 copyInfoStatus.style.color = "var(--success-color)";
                 setTimeout(() => { copyInfoStatus.textContent = ''; }, 3000);
             }).catch(err => { throw err; });
        } catch (err) {
            console.error('Copy Info Failed:', err);
            copyInfoStatus.textContent = "COPY FAILED";
            copyInfoStatus.style.color = "var(--danger-color)";
             try { // Fallback
                document.execCommand('copy');
                copyInfoStatus.textContent = `"${title}" INFO COPIED! (Fallback)`;
                copyInfoStatus.style.color = "var(--success-color)";
                setTimeout(() => { copyInfoStatus.textContent = ''; }, 3000);
            } catch (execErr) {
                 console.error('Fallback Copy Failed:', execErr);
                 copyInfoStatus.textContent = "COPY FAILED";
                 copyInfoStatus.style.color = "var(--danger-color)";
            }
        }
        window.getSelection().removeAllRanges(); // Deselect
    }
    // --- ---^^^--- END NEW Copy Single Book Info ---^^^--- ---


    // --- Poll Loading & Display ---
    function loadPoll(pollId) {
        if (!database) {
             pollTitleH1.textContent = "DATABASE ERROR";
             pollOptionsDiv.innerHTML = '<p class="placeholder-text error">[[ Cannot connect to Database ]]</p>';
             return;
        }
        adminAreaDiv.style.display = 'none';
        pollViewDiv.style.display = 'block';
        votesRevealed = false;
        pollViewDiv.classList.remove('votes-revealed');
        revealVotesArea.style.display = 'none';
        revealVotesBtn.disabled = false;
        revealVotesBtn.textContent = 'Reveal Votes';

        const pollRef = database.ref(`polls/${pollId}`);
        if (pollDataListener) { database.ref(`polls/${currentPollId}`).off('value', pollDataListener); }

        pollTitleH1.textContent = "LOADING POLL...";
        pollOptionsDiv.innerHTML = '<p class="placeholder-text">[[ Waiting For Data ]]</p>';

        pollDataListener = (snapshot) => {
            if (!snapshot.exists()) {
                pollTitleH1.textContent = "POLL NOT FOUND";
                pollOptionsDiv.innerHTML = '<p class="placeholder-text error">[[ Invalid Poll ID ]]</p>';
                revealVotesArea.style.display = 'none';
                console.error("Poll data not found for ID:", pollId);
                return;
            }
            currentPollData = snapshot.val();
            pollTitleH1.textContent = currentPollData.title || "BOOK VOTE";
            pollOptionsDiv.innerHTML = '';

            const existingCards = pollOptionsDiv.querySelectorAll('.poll-option-card.winner');
            existingCards.forEach(card => card.classList.remove('winner'));

            if (!currentPollData.options || Object.keys(currentPollData.options).length === 0) {
                 pollOptionsDiv.innerHTML = '<p class="placeholder-text">[[ No Books In Poll ]]</p>';
                 revealVotesArea.style.display = 'none';
                 return;
            }

            revealVotesArea.style.display = 'block';

            Object.entries(currentPollData.options).forEach(([key, book]) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('poll-option-card');
                cardElement.dataset.key = key;

                let cardContent = '';
                let coverHtml = '';
                const voteCount = book.votes || 0;
                let linksHtml = '';

                if (book.isManual) { // Manual entry
                     coverHtml = generateManualPlaceholderSvg(book.title);
                     linksHtml = book.link
                         ? `<div class="links"><a href="${escapeHtmlBasic(book.link)}" target="_blank" rel="noopener">User Link</a></div>`
                         : '<div class="links"></div>';

                     cardContent = `
                         <div class="poll-card-content">
                             ${coverHtml}
                             <h4>${escapeHtmlBasic(book.title)}</h4>
                             <p><em>${escapeHtmlBasic(book.author)}</em></p>
                             <p>(Manual)</p>
                             ${linksHtml}
                         </div>
                         <div class="vote-area">
                             <span class="vote-count" id="votes-${key}">${voteCount} Votes</span>
                             <button class="btn-vote" id="btn-${key}" onclick="castVote('${key}')">Vote</button>
                         </div>`;
                } else { // Standard entry
                     coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-M.jpg" alt="${escapeHtmlBasic(book.title)}" loading="lazy">`
                                                   : `<div style="width:65px; height:97px; background-color:var(--border-color); display:inline-block; line-height: 97px; text-align: center; color: var(--subtle-text-color); font-size: 0.8em;">N/A</div>`;
                    const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount}p` : '';
                    linksHtml = generateLinksHtmlVoter(book);
                    cardContent = `
                        <div class="poll-card-content">
                            ${coverHtml}
                            <h4>${escapeHtmlBasic(book.title)}</h4>
                            <p><em>${escapeHtmlBasic(book.author)}</em></p>
                            ${pageCountDisplay ? `<p>${pageCountDisplay}</p>` : ''}
                            ${linksHtml}
                        </div>
                        <div class="vote-area">
                             <span class="vote-count" id="votes-${key}">${voteCount} Votes</span>
                             <button class="btn-vote" id="btn-${key}" onclick="castVote('${key}')">Vote</button>
                         </div>`;
                }
                 cardElement.innerHTML = cardContent;
                 pollOptionsDiv.appendChild(cardElement);
            });

            if (votesRevealed) { applyWinnerHighlighting(); }
            checkIfVoted();
        };
        pollRef.on('value', pollDataListener, (error) => {
             console.error("Firebase poll read failed:", error);
             pollTitleH1.textContent = "ERROR LOADING POLL";
             pollOptionsDiv.innerHTML = '<p class="placeholder-text error">[[ Could not load poll data ]]</p>';
             pollVoteStatusDiv.textContent = "LOAD ERROR"; pollVoteStatusDiv.style.color = "var(--danger-color)";
             revealVotesArea.style.display = 'none';
         });
    }

     function generateLinksHtmlVoter(book) {
         if (book.isManual) { return `<div class="links"></div>`; }

         const openLibraryLink = book.link ? `<a href="${book.link}" target="_blank" rel="noopener">OL</a>` : '';
         const goodreadsQuery = book.isbn ? book.isbn : `${book.title} ${book.author}`;
         const goodreadsSearchLink = `https://www.goodreads.com/search?q=${encodeURIComponent(goodreadsQuery)}`;
         const showGr = book.isbn || (book.title && book.title !== '???' && book.author && book.author !== '???');
         const grLink = showGr ? `<a href="${goodreadsSearchLink}" target="_blank" rel="noopener">GR</a>` : '';
         const separator = openLibraryLink && grLink ? ' | ' : '';

         return `<div class="links">${openLibraryLink}${separator}${grLink}</div>`;
     }

    // --- Voting ---
    async function castVote(bookKey) {
        if (!database) { pollVoteStatusDiv.textContent = "DB ERROR"; return; }
        if (!currentPollId || votesRevealed) return;

        const votedPollKey = `voted_${currentPollId}`;
        if (localStorage.getItem(votedPollKey)) {
            pollVoteStatusDiv.textContent = "VOTED ALREADY";
            pollVoteStatusDiv.style.color = "var(--secondary-color)";
            disableAllVoteButtons();
            setTimeout(() => { pollVoteStatusDiv.textContent = checkIfVoted() ? "VOTED" : ''; }, 3000);
            return;
        }
        disableAllVoteButtons();
        pollVoteStatusDiv.textContent = "VOTING..."; pollVoteStatusDiv.style.color = "var(--primary-color)";
        const voteRef = database.ref(`polls/${currentPollId}/options/${bookKey}/votes`);
        try {
            const result = await voteRef.transaction(currentVotes => (currentVotes || 0) + 1);
            if (result.committed) {
                 pollVoteStatusDiv.textContent = "VOTE OK"; pollVoteStatusDiv.style.color = "var(--success-color)";
                 localStorage.setItem(votedPollKey, bookKey);
                 checkIfVoted();
            } else {
                 pollVoteStatusDiv.textContent = "VOTE FAIL"; pollVoteStatusDiv.style.color = "var(--secondary-color)";
                 checkIfVoted();
                 console.warn("Vote transaction aborted for:", bookKey);
            }
        } catch (error) {
            console.error("Vote Err:", error);
            pollVoteStatusDiv.textContent = "VOTE ERR"; pollVoteStatusDiv.style.color = "var(--danger-color)";
            checkIfVoted();
        }
        setTimeout(() => { pollVoteStatusDiv.textContent = checkIfVoted() ? "VOTED" : ''; }, 3000);
    }

    function disableAllVoteButtons() {
         const buttons = pollOptionsDiv.querySelectorAll('.btn-vote');
         buttons.forEach(button => button.disabled = true);
     }

     function checkIfVoted() {
         if (!currentPollId) return false;
         const votedPollKey = `voted_${currentPollId}`;
         const hasVoted = localStorage.getItem(votedPollKey);
         const buttons = pollOptionsDiv.querySelectorAll('.btn-vote');

         if (hasVoted || votesRevealed) {
             buttons.forEach(button => button.disabled = true);
             if (hasVoted && (!pollVoteStatusDiv.textContent || pollVoteStatusDiv.textContent === "VOTING..." || pollVoteStatusDiv.textContent === "")) {
                pollVoteStatusDiv.textContent = "VOTED";
                pollVoteStatusDiv.style.color = "var(--subtle-text-color)";
             }
             return true;
         } else {
             buttons.forEach(button => button.disabled = false);
             if (pollVoteStatusDiv.textContent === "VOTED") {
                 pollVoteStatusDiv.textContent = "";
             }
             return false;
         }
     }

    // --- Reveal Votes Logic ---
    function revealVotes() {
        if (!currentPollData || !currentPollData.options || votesRevealed) { return; }
        votesRevealed = true;
        pollViewDiv.classList.add('votes-revealed');
        applyWinnerHighlighting();
        revealVotesBtn.textContent = 'Results Shown';
        revealVotesBtn.disabled = true;
        disableAllVoteButtons();
        if (!localStorage.getItem(`voted_${currentPollId}`)) {
            pollVoteStatusDiv.textContent = "POLL CLOSED";
             pollVoteStatusDiv.style.color = "var(--subtle-text-color)";
        }
    }

    function applyWinnerHighlighting() {
         if (!currentPollData || !currentPollData.options) return;
         let maxVotes = -1;
         Object.values(currentPollData.options).forEach(book => {
             maxVotes = Math.max(maxVotes, book.votes || 0);
         });

         const allCards = pollOptionsDiv.querySelectorAll('.poll-option-card');
         allCards.forEach(card => card.classList.remove('winner'));

         if (maxVotes > 0) {
             Object.entries(currentPollData.options).forEach(([key, book]) => {
                 if ((book.votes || 0) === maxVotes) {
                     const winnerCard = pollOptionsDiv.querySelector(`.poll-option-card[data-key="${key}"]`);
                     if (winnerCard) { winnerCard.classList.add('winner'); }
                 }
             });
         }
    }

    // --- Initialization ---
    window.onload = () => {
        if (typeof database === 'undefined') {
            console.error("Database object not initialized. Halting execution.");
            return;
        }
        currentPollId = getPollIdFromUrl();
        if (currentPollId) {
            loadPoll(currentPollId);
        } else {
            adminAreaDiv.style.display = 'block';
            pollViewDiv.style.display = 'none';
            displaySelectedBooksAdmin(); // Initial display & button state check
        }
    };

    // --- Listener Cleanup ---
    window.addEventListener('beforeunload', () => {
        if (database && pollDataListener && currentPollId) {
             try {
                 const pollRef = database.ref(`polls/${currentPollId}`);
                 pollRef.off('value', pollDataListener);
                 console.log("Firebase listener detached for poll:", currentPollId);
             } catch (e) {
                 console.error("Error detaching Firebase listener:", e);
             }
        }
    });

</script>

</body>
</html>
