<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Club Poll App</title> <!-- Consider changing -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f9; /* Lighter blueish gray */
            --card-bg: #ffffff;
            --primary-color: #4a7ee2; /* Using the slightly softer blue */
            --secondary-color: #f59e4b;
            --text-color: #334155; /* Darker slate */
            --subtle-text-color: #64748b; /* Lighter slate */
            --border-color: #e2e8f0;
            --input-border-color: #cbd5e1;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --card-hover-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --placeholder-bg: #e5e7eb; /* Gray for placeholders */
        }

        body {
            font-family: 'Inter', sans-serif; line-height: 1.6; margin: 0;
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: flex-start;
            padding: 40px 15px; min-height: 100vh;
        }

        .container {
            max-width: 900px; width: 100%; background: var(--card-bg);
            padding: 30px 40px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); margin: 20px 0;
        }

        h1, h2 { text-align: center; font-weight: 600; margin-bottom: 25px; }
        h1 { color: var(--primary-color); font-size: 2.1em; margin-bottom: 40px; }
        h2 { font-size: 1.4em; margin-top: 40px; margin-bottom: 25px; text-align: left;
             border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
             color: var(--subtle-text-color); font-weight: 500; }

        section { margin-bottom: 35px; padding-bottom: 15px; }

        /* --- Search Input Area --- */
        .search-input-wrapper { position: relative; margin-bottom: 15px; max-width: 500px; /* Limit width */ }
        #searchInput {
            width: 100%; padding: 11px 35px 11px 15px; /* Space for clear button */
            border: 1px solid var(--input-border-color); border-radius: 8px;
            font-size: 0.95em; box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #searchInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 126, 226, 0.2); outline: none;
        }
        #clearSearchBtn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; font-size: 1.4em; color: #9ca3af;
            cursor: pointer; padding: 0 5px; line-height: 1; display: none; /* Hide initially */
        }
        #clearSearchBtn:hover { color: var(--text-color); }

        /* --- Search Results --- */
        #searchResults { max-height: 280px; overflow-y: auto; padding-right: 5px; margin-bottom: 15px; }
        .book-item {
            display: flex; align-items: center; border-bottom: 1px solid var(--border-color);
            padding: 10px 5px; margin-bottom: 0px; background-color: transparent; border-radius: 0;
            transition: background-color 0.2s ease;
        }
        .book-item:last-child { border-bottom: none; }
        .book-item:hover { background-color: #f8fafc; }
        .book-item img, .book-item .placeholder-svg {
            width: 38px; height: 57px; object-fit: cover; margin-right: 12px;
            border-radius: 3px; background-color: var(--placeholder-bg); flex-shrink: 0;
        }
        .book-info { flex-grow: 1; overflow: hidden; padding-right: 10px; }
        .book-info strong { font-size: 0.95em; color: var(--text-color); font-weight: 500; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-info p { margin: 1px 0; font-size: 0.8em; color: var(--subtle-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-item button { margin-left: auto; padding: 6px 12px; font-size: 0.8em; flex-shrink: 0; }
        .book-item button:disabled { background-color: #d1d5db; border-color: #d1d5db; color: #6b7280; cursor: not-allowed; }

        /* --- Custom Add Area --- */
        #customBookArea { display: flex; align-items: center; flex-wrap: wrap; margin-top: 15px; padding: 15px; background-color: #f9fafb; border: 1px dashed var(--border-color); border-radius: 8px; }
        #customBookArea label { margin-right: 5px; font-size: 0.9em; color: var(--subtle-text-color); }
        #customBookArea input[type="text"] { margin-right: 10px; margin-bottom: 5px; }
        #customTitle { width: 230px; } #customAuthor { width: 190px; }

        /* --- Buttons General --- */
        button { padding: 9px 18px; font-size: 0.9em; font-weight: 500; color: white; background-color: var(--primary-color); border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; text-align: center; line-height: 1.4; }
        button:hover { opacity: 0.85; transform: translateY(-1px); }
        button:active { transform: scale(0.98); opacity: 1; }
        button:disabled { background-color: #a0bce8; cursor: not-allowed; opacity: 0.7; transform: none; }
        .btn-remove{background-color:#ef4444} .btn-remove:hover{background-color:#dc2626}
        #startPollBtn{background-color:var(--secondary-color)} #startPollBtn:hover{background-color:#f97316} #startPollBtn:disabled{background-color:#fdba74; cursor: not-allowed;}
        #addCustomBtn{background-color:#22c55e} #addCustomBtn:hover{background-color:#16a34a}
        #revealResultsBtn { background-color: #6366f1; margin-top: 20px; } #revealResultsBtn:hover { background-color: #4f46e5; }
        .btn-vote{background-color:#10b981} .btn-vote:hover{background-color:#059669} .btn-vote:disabled{background-color:#6ee7b7;cursor:not-allowed}

        /* --- Selected Books (Admin) --- */
        #selectedBooksList{display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:18px; margin-top:20px;}
        .selected-card{background-color:var(--card-bg); border:1px solid var(--border-color); border-radius:8px; box-shadow:var(--card-shadow); text-align:center; display:flex; flex-direction:column; padding:15px; transition: all 0.2s ease;}
        .selected-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .selected-card img, .selected-card .placeholder-svg{width:70px; height:105px; object-fit:cover; border-radius:4px; background-color:var(--placeholder-bg); margin:0 auto 10px auto;}
        .selected-card h3{font-size:.95em; margin:4px 0 2px 0; font-weight:600; line-height:1.3;}
        .selected-card p{font-size:.8em; color:var(--subtle-text-color); margin:2px 0;}
        .selected-card .links{margin-top:8px; font-size:.75em; line-height:1.4; margin-bottom:10px;}
        .selected-card .links a{color:var(--primary-color);text-decoration:none; margin:0 3px;} .selected-card .links a:hover{text-decoration:underline;}
        .selected-card .btn-remove{margin-top:auto; font-size:.8em; padding:6px 12px;}

        /* --- Poll View & 3D Cards --- */
        #pollView { margin-top: 20px; text-align: center; }
        #pollTitle { font-size: 1.6em; margin-bottom: 25px; font-weight: 600; color: var(--text-color); }
        .poll-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; margin-top: 20px; perspective: 1200px; }
        .quiz-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px;
            padding: 20px; box-shadow: var(--card-shadow); text-align: center;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            display: flex; flex-direction: column; justify-content: space-between;
            transform-style: preserve-3d; cursor: pointer; min-height: 380px; /* Ensure space */
        }
        .quiz-card:hover { transform: rotateY(8deg) rotateX(3deg) translateZ(15px); box-shadow: var(--card-hover-shadow); }
        .quiz-card .card-content-wrapper { flex-grow: 1; /* Allow content to push footer down */ }
        .quiz-card img, .quiz-card .placeholder-svg { width: 95px; height: 142px; object-fit: cover; border-radius: 5px; background-color: var(--placeholder-bg); margin: 0 auto 15px auto; border: 1px solid #eee; }
        .quiz-card h4 { margin: 5px 0 3px 0; font-size: 1.1em; font-weight: 600; line-height: 1.3; }
        .quiz-card p { margin: 4px 0; font-size: 0.85em; color: var(--subtle-text-color); }
        .quiz-card .links { margin: 12px 0; font-size: 0.75em; line-height: 1.4; }
        .quiz-card .links a { margin: 0 4px; }
        .vote-area { margin-top: 15px; display: flex; align-items: center; justify-content: space-between; width: 100%; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .vote-count { font-size: 1.1em; font-weight: 600; color: var(--primary-color); visibility: hidden; /* Hide initially */ opacity: 0; transition: visibility 0s linear 0.3s, opacity 0.3s ease-in-out; }
        .vote-count.visible { visibility: visible; opacity: 1; transition-delay: 0s; }

        /* --- Status Messages & Share Area --- */
        .status-message{text-align:center; padding:8px 0; color:var(--subtle-text-color); font-size:.85em;}
        .loading{font-weight:500; color:var(--primary-color);} .error{color:#ef4444; font-weight:500;}
        .placeholder-text{color:#9ca3af; text-align:center; padding:25px 0; font-style:italic; font-size:.9em;}
        #pollShareArea{margin-top:25px; padding:18px; background-color:#f0fdf4; border:1px solid #a7f3d0; border-radius:8px; text-align:center;}
        #pollShareLink{font-weight:600; word-break:break-all; display:inline-block; margin:8px 0; background:#fff; padding:6px 12px; border:1px solid #ccc; border-radius:6px;}
        #copyStatus { font-size: 0.8em; min-height: 1.2em; margin-top: 5px; }
        #adminArea{display:block} #pollView{display:none}

    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<div class="container">

    <!-- Section 1: Poll Creation Interface (Admin View) -->
    <div id="adminArea">
        <h1>Book Poll Creator</h1>
        <section class="add-books-area">
            <h2>1. Find or Add Books</h2>
            <div class="search-input-wrapper">
                <label for="searchInput" class="sr-only">Search Open Library:</label> <!-- Hide label visually if needed -->
                <input type="text" id="searchInput" placeholder="Search title or author..." aria-label="Search Open Library">
                <button id="clearSearchBtn" onclick="clearSearch()" aria-label="Clear search">×</button>
            </div>
            <div id="searchStatus" class="status-message"></div>
            <div id="searchResults"></div>
            <div id="customBookArea">
                 <label for="customTitle">Add Manually:</label>
                 <input type="text" id="customTitle" placeholder="Book Title (Required)" aria-label="Custom Book Title">
                 <label for="customAuthor">by</label>
                 <input type="text" id="customAuthor" placeholder="Author (Optional)" aria-label="Custom Book Author">
                 <button id="addCustomBtn" onclick="addCustomBook()">Add</button>
            </div>
            <div id="customAddStatus" class="status-message error" style="text-align: left; padding-left: 15px;"></div>
        </section>
        <section class="selected-area">
            <h2>2. Selected Books</h2>
            <div id="selectedBooksList"> <p class="placeholder-text">No books selected.</p> </div>
            <div style="text-align: center; margin-top: 30px;">
                <button id="startPollBtn" onclick="startPoll()">Start Poll & Get Share Link</button>
            </div>
            <div id="pollShareArea" style="display: none;"> Poll Created! Share this link: <br><a id="pollShareLink" href="#" target="_blank" rel="noopener noreferrer"></a> <br><button onclick="copyPollLink()" style="margin-top:10px; background-color: var(--primary-color)">Copy Link</button> <div id="copyStatus" class="status-message"></div> </div>
            <div id="startPollStatus" class="status-message error"></div>
        </section>
    </div>

    <!-- Section 2: Live Poll Display (Voter View) -->
    <div id="pollView">
        <h1 id="pollTitle">Loading Poll...</h1>
        <div id="pollOptions" class="poll-options">
            <p class="placeholder-text">Waiting for poll data...</p>
        </div>
        <div id="pollVoteStatus" class="status-message" style="margin-top: 15px; font-weight: bold;"></div>
        <div id="revealButtonContainer" style="text-align: center;">
             <button id="revealResultsBtn" onclick="revealResults()">Reveal Results</button>
        </div>
    </div>

</div>

<script>
    // ---vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv---
    // --- YOUR FIREBASE CONFIGURATION                   ---
    // ---   (Make sure databaseURL is correct!)         ---
    // ---vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv---
    const firebaseConfig = {
      apiKey: "AIzaSyAPi4OmZieXOwy3fDhXPPt9ac_KCE0_hkw",
      authDomain: "book-klubben-236e1.firebaseapp.com",
      databaseURL: "https://book-klubben-236e1-default-rtdb.europe-west1.firebasedatabase.app", // Updated!
      projectId: "book-klubben-236e1",
      storageBucket: "book-klubben-236e1.appspot.com",
      messagingSenderId: "245694652120",
      appId: "1:245694652120:web:f550759de576dea4c7c1ad"
    };
    // ---^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^---

    // --- Initialize Firebase ---
    try {
         if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    } catch(e) { console.error("Firebase init error:", e); alert("Could not initialize Firebase."); }
    const database = firebase.database();

    // --- DOM Elements ---
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchResultsDiv = document.getElementById('searchResults');
    const searchStatusDiv = document.getElementById('searchStatus');
    const customTitleInput = document.getElementById('customTitle');
    const customAuthorInput = document.getElementById('customAuthor');
    const customAddStatusDiv = document.getElementById('customAddStatus');
    const selectedBooksListDiv = document.getElementById('selectedBooksList');
    const startPollBtn = document.getElementById('startPollBtn');
    const startPollStatus = document.getElementById('startPollStatus');
    const pollShareArea = document.getElementById('pollShareArea');
    const pollShareLink = document.getElementById('pollShareLink');
    const copyStatusDiv = document.getElementById('copyStatus');
    const adminAreaDiv = document.getElementById('adminArea');
    const pollViewDiv = document.getElementById('pollView');
    const pollTitleH1 = document.getElementById('pollTitle');
    const pollOptionsDiv = document.getElementById('pollOptions');
    const pollVoteStatusDiv = document.getElementById('pollVoteStatus');
    const revealButtonContainer = document.getElementById('revealButtonContainer');
    const revealResultsBtn = document.getElementById('revealResultsBtn');

    // --- State ---
    let selectedBooks = [];
    let searchTimeoutId = null;
    let currentPollId = null;
    let currentPollData = null;
    let pollDataListener = null;

    // --- Improved Placeholder SVG ---
    const placeholderSvg = `<svg width="70" height="105" viewBox="0 0 70 105" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="70" height="105" rx="4" fill="#E5E7EB"/><path d="M18 85H52V90H18z M18 75H52V80H18z" fill="#D1D5DB"/><path d="M35 65 C43 65 48 55 35 40 C22 55 27 65 35 65 Z" fill="#D1D5DB"/></svg>`;
    const searchResultPlaceholderSvg = `<svg width="38" height="57" viewBox="0 0 38 57" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="38" height="57" rx="2" fill="#E5E7EB"/><path d="M10 48 H28 V 51 H10 z M10 42 H28 V 45 H10 z" fill="#D1D5DB"/><path d="M19 36 C23 36 26 30 19 22 C12 30 15 36 19 36 Z" fill="#D1D5DB"/></svg>`;
    const pollCardPlaceholderSvg = `<svg width="95" height="142" viewBox="0 0 95 142" fill="none" xmlns="http://www.w3.org/2000/svg" class="placeholder-svg"><rect width="95" height="142" rx="5" fill="#E5E7EB"/><path d="M25 115 H70 V 122 H25 z M25 100 H70 V 107 H25 z" fill="#D1D5DB"/><path d="M47.5 88 C57.5 88 64 75 47.5 55 C31 75 37.5 88 47.5 88 Z" fill="#D1D5DB"/></svg>`;


    // --- Utility ---
    function debounce(func, delay) { return function(...args) { clearTimeout(searchTimeoutId); searchTimeoutId = setTimeout(() => func.apply(this, args), delay); }; }
    function getPollIdFromUrl() { const params = new URLSearchParams(window.location.search); return params.get('pollId'); }

    // --- Search & Input Handling ---
    async function performSearch() {
        const query = searchInput.value.trim();
        searchResultsDiv.innerHTML = '';
        clearSearchBtn.style.display = query ? 'block' : 'none'; // Show/hide clear button
        if (!query) { searchStatusDiv.innerHTML = ''; return; }
        searchStatusDiv.innerHTML = '<p class="loading">Searching...</p>';
        // Added 'type' to fields request
        const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=15&fields=key,title,author_name,cover_i,number_of_pages_median,isbn,type`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
            const data = await response.json();
            searchStatusDiv.innerHTML = '';
            displaySearchResults(data.docs);
        } catch (error) { console.error('Search Error:', error); searchStatusDiv.innerHTML = `<p class="error">Search failed.</p>`; searchResultsDiv.innerHTML = ''; }
    }
    const debouncedSearch = debounce(performSearch, 400);
    searchInput.addEventListener('input', debouncedSearch);

    function clearSearch() {
        searchInput.value = '';
        searchResultsDiv.innerHTML = '';
        searchStatusDiv.innerHTML = '';
        clearSearchBtn.style.display = 'none';
        searchInput.focus();
    }

    function displaySearchResults(books) {
        searchResultsDiv.innerHTML = ''; // Clear previous
        if (!books || books.length === 0) { searchResultsDiv.innerHTML = '<p class="placeholder-text" style="padding: 10px 0;">No matches found.</p>'; return; }

        // Filter results - prioritize works and books, require a key
        const filteredBooks = books.filter(book =>
            book.key &&
            (book.key.startsWith('/works/') || book.key.startsWith('/books/')) && // Ensure it has a valid key format
            (!book.type || book.type.key === '/type/work' || book.type.key === '/type/edition') // Optional: Prioritize work/edition types
        );

        if (filteredBooks.length === 0) {
             searchResultsDiv.innerHTML = '<p class="placeholder-text" style="padding: 10px 0;">No relevant books found.</p>'; return;
        }

        filteredBooks.forEach(book => {
            const title = book.title || 'Unknown Title';
            const authors = book.author_name ? book.author_name.join(', ') : 'Unknown Author';
            const coverId = book.cover_i;
            const coverHtml = coverId ? `<img src="https://covers.openlibrary.org/b/id/${coverId}-S.jpg" alt="" loading="lazy">` : searchResultPlaceholderSvg;
            const pageCount = book.number_of_pages_median || 'N/A'; // Get page count
            const bookKey = book.key; // Already validated this exists and format
            const isbn = book.isbn ? book.isbn[0] : null;
            const isSelected = selectedBooks.some(b => b.key === bookKey);

            const bookElement = document.createElement('div');
            bookElement.className = `book-item${isSelected ? ' selected' : ''}`;
            bookElement.dataset.key = bookKey;
            // Added Page Count to display
            bookElement.innerHTML = `
                ${coverHtml}
                <div class="book-info">
                    <strong>${title}</strong>
                    <p>${authors}</p>
                    <p>Pages: ${pageCount}</p>
                </div>
                <button onclick="selectBook(this, '${bookKey}', '${title}', '${authors}', '${coverId || ''}', '${pageCount}', '${isbn || ''}')" ${isSelected ? 'disabled' : ''}>
                    ${isSelected ? 'Selected' : 'Select'}
                </button>`;
            searchResultsDiv.appendChild(bookElement);
        });
    }

    // --- Custom Book ---
    function addCustomBook() {
        const title = customTitleInput.value.trim(), author = customAuthorInput.value.trim()||'Unknown Author';
        customAddStatusDiv.textContent=''; if (!title) { customAddStatusDiv.textContent = 'Title required.'; customTitleInput.focus(); return; }
        const alreadyExists = selectedBooks.some(b=>b.title.toLowerCase() === title.toLowerCase() && b.authors.toLowerCase() === author.toLowerCase());
        if (alreadyExists) { customAddStatusDiv.textContent = 'Already selected.'; return; }
        const customKey = 'custom_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7);
        const bookData = { key: customKey, title, authors: author, coverId: null, pageCount: 'N/A', isbn: null, isCustom: true, link: '' };
        selectedBooks.push(bookData); displaySelectedBooksAdmin(); customTitleInput.value = ''; customAuthorInput.value = '';
    }

    // --- Selection & Admin Display ---
    function selectBook(buttonElement, key, title, authors, coverId, pageCount, isbn) {
        if (selectedBooks.some(b => b.key === key)) return; // Prevent double adding if button state lags
        // Only generate OL link if it's a work or book key
        const link = (key.startsWith('/works/') || key.startsWith('/books/')) ? `https://openlibrary.org${key}` : '';
        const bookData = { key, title, authors, coverId, pageCount, isbn, isCustom: false, link };
        selectedBooks.push(bookData);
        displaySelectedBooksAdmin();
        // Disable button in the specific item clicked
        buttonElement.textContent = 'Selected';
        buttonElement.disabled = true;
        buttonElement.closest('.book-item').classList.add('selected'); // Optional visual cue
    }


    function removeBook(keyToRemove) {
        selectedBooks = selectedBooks.filter(book => book.key !== keyToRemove);
        displaySelectedBooksAdmin();
        // Re-enable button in search results if it exists
        const bookItemInSearch = searchResultsDiv.querySelector(`.book-item[data-key="${keyToRemove}"]`);
        if(bookItemInSearch){
            const btn = bookItemInSearch.querySelector('button');
            if(btn){ btn.textContent='Select'; btn.disabled=false; }
            bookItemInSearch.classList.remove('selected'); // Remove visual cue
        }
    }

    function generateLinksHtmlAdmin(book) { /* Keep as is for admin */
        if (book.isCustom || !book.link) return `<div class="links" style="font-size:0.9em;color:#999;">(Custom)</div>`;
        const goodreadsSearchLink = `https://www.goodreads.com/search?q=${encodeURIComponent(book.isbn || `${book.title} ${book.authors}`)}`;
        return `<div class="links"><a href="${book.link}" target="_blank">OL</a> | <a href="${goodreadsSearchLink}" target="_blank">GR</a></div>`;
    }

     function displaySelectedBooksAdmin() { /* Keep as is */
        selectedBooksListDiv.innerHTML = '';
        pollShareArea.style.display = 'none'; copyStatusDiv.textContent = '';
        if (selectedBooks.length === 0) { selectedBooksListDiv.innerHTML = '<p class="placeholder-text">No books selected.</p>'; startPollBtn.disabled = true; return; }
        startPollBtn.disabled = false;
        selectedBooks.forEach(book => {
            const coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-S.jpg" alt="${book.title}" loading="lazy">` : placeholderSvg;
            const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount} pgs` : 'N/A pgs';
            const linksHtml = generateLinksHtmlAdmin(book);
            const cardElement = document.createElement('div'); cardElement.classList.add('selected-card');
            cardElement.innerHTML = `${coverHtml}<h3>${book.title}</h3><p><em>${book.authors}</em></p><p>${pageCountDisplay}</p>${linksHtml}<button class="btn-remove" onclick="removeBook('${book.key}')">Remove</button>`;
            selectedBooksListDiv.appendChild(cardElement);
        });
    }

    // --- Poll Creation (Firebase) ---
    async function startPoll() { /* Keep as is */
        if (selectedBooks.length === 0) { startPollStatus.textContent = "Please select at least one book."; return; }
        startPollStatus.textContent = ""; startPollBtn.disabled = true; startPollBtn.textContent = "Starting...";
        const pollOptions = {};
        selectedBooks.forEach((book) => {
            const safeKey = book.key.replace(/[.$#[\]/]/g, '_');
            pollOptions[safeKey] = { title: book.title, author: book.authors, pageCount: book.pageCount, link: book.link, coverId: book.coverId, isCustom: book.isCustom, votes: 0 };
        });
        const pollData = { title: "Book Club Poll - " + new Date().toLocaleDateString(), options: pollOptions, createdAt: firebase.database.ServerValue.TIMESTAMP };
        try {
            const newPollRef = database.ref('polls').push();
            await newPollRef.set(pollData);
            currentPollId = newPollRef.key;
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const shareUrl = `${baseUrl}?pollId=${currentPollId}`;
            pollShareLink.textContent = shareUrl; pollShareLink.href = shareUrl;
            pollShareArea.style.display = 'block'; startPollBtn.textContent = "Poll Started!"; copyStatusDiv.textContent = '';
        } catch (error) { console.error("Error starting poll:", error); startPollStatus.textContent = "Error starting poll."; startPollBtn.disabled = false; startPollBtn.textContent = "Start Poll & Get Share Link"; }
    }

     function copyPollLink() { /* Keep as is */
        const link = pollShareLink.textContent;
        navigator.clipboard.writeText(link).then(() => { copyStatusDiv.textContent = "Link copied!"; copyStatusDiv.style.color = 'green'; setTimeout(() => { copyStatusDiv.textContent = ''; }, 3000); })
        .catch(err => { copyStatusDiv.textContent = "Copy failed."; copyStatusDiv.style.color = 'red'; console.error('Failed to copy link: ', err); });
     }

    // --- Poll Loading & Display (Voter View) ---
    function loadPoll(pollId) {
        console.log("Loading poll:", pollId);
        adminAreaDiv.style.display = 'none'; pollViewDiv.style.display = 'block';
        revealButtonContainer.style.display = 'block'; // Show reveal button container
        revealResultsBtn.style.display = 'inline-block'; // Ensure reveal button is visible initially

        const pollRef = database.ref(`polls/${pollId}`);
        if (pollDataListener) { pollRef.off('value', pollDataListener); } // Detach previous listener

        pollDataListener = (snapshot) => {
            if (!snapshot.exists()) { pollTitleH1.textContent = "Poll Not Found"; pollOptionsDiv.innerHTML = "<p class='error'>Poll ID invalid or deleted.</p>"; revealButtonContainer.style.display = 'none'; return; }
            currentPollData = snapshot.val(); currentPollId = pollId;
            pollTitleH1.textContent = currentPollData.title || "Book Club Poll";
            pollOptionsDiv.innerHTML = ''; // Clear before re-rendering

            if (!currentPollData.options || Object.keys(currentPollData.options).length === 0) { pollOptionsDiv.innerHTML = "<p class='placeholder-text'>No options found.</p>"; revealButtonContainer.style.display = 'none'; return; }

            Object.entries(currentPollData.options).forEach(([key, book]) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('quiz-card'); // Use 3D card style

                const coverHtml = book.coverId ? `<img src="https://covers.openlibrary.org/b/id/${book.coverId}-M.jpg" alt="${book.title}" loading="lazy">` : pollCardPlaceholderSvg; // Use poll placeholder
                const pageCountDisplay = (book.pageCount && book.pageCount !== 'N/A') ? `${book.pageCount} pages` : 'Pages: N/A'; // Use "pages"
                const linksHtml = generateLinksHtmlVoter(book); // Generate OL link

                // Render card structure - vote count is present but hidden by CSS initially
                cardElement.innerHTML = `
                    <div class="card-content-wrapper">
                        ${coverHtml}
                        <h4>${book.title}</h4>
                        <p><em>by ${book.author}</em></p>
                        <p>${pageCountDisplay}</p>
                        ${linksHtml}
                    </div>
                    <div class="vote-area">
                        <span class="vote-count" id="votes-${key}">${book.votes || 0} Votes</span>
                        <button class="btn-vote" id="btn-${key}" onclick="castVote('${key}')">Vote</button>
                    </div>
                `;
                pollOptionsDiv.appendChild(cardElement);
            });
            checkIfVoted(); // Check voting status after rendering
             // Check if results were previously revealed (e.g., on page refresh after revealing)
            if (localStorage.getItem(`results_revealed_${currentPollId}`)) {
                revealResults(true); // Reveal immediately without hiding button again
            }

        };
        pollRef.on('value', pollDataListener, (error) => {
            console.error("Error loading poll data:", error); pollTitleH1.textContent = "Error Loading Poll";
            pollOptionsDiv.innerHTML = "<p class='error'>Could not fetch poll data.</p>";
            revealButtonContainer.style.display = 'none';
        });
    }

    function generateLinksHtmlVoter(book) {
        // Only show Open Library link in the voter card
        if (book.isCustom || !book.link) return `<div class="links"></div>`;
        return `<div class="links"><a href="${book.link}" target="_blank" rel="noopener">View on Open Library</a></div>`;
    }

    // --- Voting ---
    async function castVote(bookKey) { /* Keep as is */
        if (!currentPollId) return;
        const votedPollKey = `voted_${currentPollId}`;
        if (localStorage.getItem(votedPollKey)) { pollVoteStatusDiv.textContent = "You have already voted."; pollVoteStatusDiv.style.color = "orange"; disableAllVoteButtons(); setTimeout(() => { pollVoteStatusDiv.textContent = ''; }, 4000); return; }
        const voteButton = document.getElementById(`btn-${bookKey}`);
        disableAllVoteButtons(); pollVoteStatusDiv.textContent = "Registering vote..."; pollVoteStatusDiv.style.color = "var(--primary-color)";
        const voteRef = database.ref(`polls/${currentPollId}/options/${bookKey}/votes`);
        try {
            const result = await voteRef.transaction(currentVotes => (currentVotes || 0) + 1);
            if (result.committed) { pollVoteStatusDiv.textContent = "Vote registered!"; pollVoteStatusDiv.style.color = "green"; localStorage.setItem(votedPollKey, bookKey); }
            else { pollVoteStatusDiv.textContent = "Vote failed (conflict)."; pollVoteStatusDiv.style.color = "orange"; checkIfVoted(); }
        } catch (error) { console.error("Error casting vote:", error); pollVoteStatusDiv.textContent = "Error registering vote."; pollVoteStatusDiv.style.color = "red"; checkIfVoted(); }
        setTimeout(() => { pollVoteStatusDiv.textContent = ''; }, 4000);
    }

    function disableAllVoteButtons() { pollOptionsDiv.querySelectorAll('.btn-vote').forEach(button => button.disabled = true); }
    function enableAllVoteButtons() { pollOptionsDiv.querySelectorAll('.btn-vote').forEach(button => button.disabled = false); } // Helper if needed

    function checkIfVoted() {
        const votedOptionKey = localStorage.getItem(`voted_${currentPollId}`);
         if (votedOptionKey) {
             disableAllVoteButtons();
             // Don't show status permanently, let reveal handle results visibility
             // pollVoteStatusDiv.textContent = "You have voted.";
             // pollVoteStatusDiv.style.color = "var(--subtle-text-color)";
         } else {
             enableAllVoteButtons(); // Ensure buttons are enabled if not voted
         }
     }

    // --- Reveal Results ---
    function revealResults(isPageLoad = false) {
        const voteCounts = pollOptionsDiv.querySelectorAll('.vote-count');
        voteCounts.forEach(span => {
            span.classList.add('visible'); // Add class to trigger CSS transition/visibility
        });

        if (!isPageLoad) { // Only hide button and set flag if explicitly clicked
             revealResultsBtn.style.display = 'none'; // Hide the button
             localStorage.setItem(`results_revealed_${currentPollId}`, 'true'); // Remember state
        } else if (revealResultsBtn) {
             revealResultsBtn.style.display = 'none'; // Also hide button if revealed on page load
        }
    }


    // --- Initialization ---
    window.onload = () => {
        const pollId = getPollIdFromUrl();
        if (pollId) {
            loadPoll(pollId);
        } else {
            adminAreaDiv.style.display = 'block';
            pollViewDiv.style.display = 'none';
            displaySelectedBooksAdmin();
        }
    };

</script>

</body>
</html>
